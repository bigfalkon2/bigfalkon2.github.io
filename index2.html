<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli - Gelişmiş Görünüm</title>
  <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#443a74"/>
    <script>
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(function() {
                console.log('Service Worker Kaydedildi');
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Metamorphous&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            --md-sys-color-primary-rgb: 189, 179, 255;
            --md-sys-color-primary: rgb(var(--md-sys-color-primary-rgb));
            --md-sys-color-on-primary: #2d235c;
            --md-sys-color-primary-container: #443a74;
            --md-sys-color-on-primary-container: #e6deff;
            --md-sys-color-background: #131318;
            --md-sys-color-on-background: #e5e1e6;
            --md-sys-color-surface: #1a191f;
            --md-sys-color-surface-container: #201f25;
            --md-sys-color-surface-container-high: #2a2830;
            --md-sys-color-on-surface: #e5e1e6;
            --md-sys-color-on-surface-variant: #c8c4d0;
            --md-sys-color-outline-variant: #48454e;
            --md-sys-color-success-rgb: 102, 187, 106;
            --md-sys-color-success: rgb(var(--md-sys-color-success-rgb));
            --md-sys-color-on-success: #ffffff;
            --md-sys-color-danger-rgb: 239, 83, 80;
            --md-sys-color-danger: rgb(var(--md-sys-color-danger-rgb));
            --md-sys-color-on-danger: #ffffff;
            --md-sys-color-warning-rgb: 255, 183, 77;
            --md-sys-color-warning: rgb(var(--md-sys-color-warning-rgb));
        }
        body { font-family: 'Manrope', sans-serif; background-color: var(--md-sys-color-background); color: var(--md-sys-color-on-background); }
        .form-input, .form-select { background-color: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant); color: var(--md-sys-color-on-surface); border-radius: 8px; padding: 12px; width: 100%; transition: all 0.2s ease; }
        .form-input:focus, .form-select:focus { border-color: var(--md-sys-color-primary); box-shadow: 0 0 0 3px rgba(var(--md-sys-color-primary-rgb), 0.2); outline: none; }
        .item-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 16px; background-color: var(--md-sys-color-surface-container); transition: all 0.2s ease-in-out; border: 1px solid var(--md-sys-color-outline-variant); }
        .item-card:hover { transform: translateY(-4px); background-color: var(--md-sys-color-surface-container-high); box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
        .item-card.retired { opacity: 0.7; border-left: 4px solid var(--md-sys-color-warning); }
        .item-card.retired:hover { transform: translateY(0); opacity: 0.8; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-weight: 700; text-decoration: none; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-success { background-color: var(--md-sys-color-success); color: var(--md-sys-color-on-success); }
        .btn-secondary { background-color: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface-variant); border: 1px solid var(--md-sys-color-outline-variant); }
        .btn-secondary:hover { border-color: var(--md-sys-color-primary); color: var(--md-sys-color-primary); background-color: rgba(var(--md-sys-color-primary-rgb), 0.08); transform: translateY(0); box-shadow: none; }
        .btn-danger { background-color: var(--md-sys-color-danger); color: var(--md-sys-color-on-danger); }
        .icon-button { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; border-radius: 50%; background-color: transparent; color: var(--md-sys-color-on-surface-variant); cursor: pointer; transition: all 0.2s; }
        .icon-button:hover.edit-button { background-color: rgba(var(--md-sys-color-primary-rgb), 0.1); color: var(--md-sys-color-primary); }
        .icon-button:hover.delete-button { background-color: rgba(var(--md-sys-color-danger-rgb), 0.1); color: var(--md-sys-color-danger); }
        .icon-button:hover.retire-button { background-color: rgba(var(--md-sys-color-warning-rgb), 0.1); color: var(--md-sys-color-warning); }
        .modal-backdrop { z-index: 1000; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--md-sys-color-surface-container); border-radius: 24px; padding: 2rem; width: 100%; max-width: 400px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .report-modal-content h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.75rem; border-bottom: 1px solid var(--md-sys-color-outline-variant); padding-bottom: 0.5rem; }
        .report-modal-content p { margin-bottom: 0.5rem; }
        .enlarged-image-container { z-index: 1100; position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .enlarged-image { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
        .character-selector-item { display: flex; align-items: center; gap: 1rem; padding: 0.5rem; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .character-selector-item:hover { background-color: var(--md-sys-color-surface-container-high); }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="app" class="max-w-screen-xl mx-auto">
        <header class="flex justify-between items-center mb-8 pb-4 border-b" style="border-color: var(--md-sys-color-outline-variant);">
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold" style="color: var(--md-sys-color-primary);">Yönetim Paneli</h1>
                <p class="text-lg mt-2" style="color: var(--md-sys-color-on-surface-variant);">Karakterleri, Füzyonları ve Gizli Sırları Yönet</p>
            </div>
            <div id="auth-button-container">
                <button id="auth-action-btn" class="btn btn-secondary"><span id="auth-action-icon" class="material-symbols-outlined">login</span><span id="auth-action-text">Giriş Yap</span></button>
            </div>
        </header>
        
        <div class="mb-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-center">
            <input type="text" id="search-input" placeholder="Kayıtlar içinde ara..." class="form-input md:col-span-2">
            
            <select id="view-filter" class="form-select">
                <option value="all">Tüm Kayıtlar</option>
                <option value="available">Boştaki Karakterler</option>
                <option value="preview-report">Füzyon Önizleme Raporu</option>
            </select>

            <select id="sort-by" class="form-select">
                <option value="name_asc">İsme Göre (A-Z)</option>
                <option value="date_desc">Eklenme Tarihi (Yeni)</option>
                <option value="date_asc">Eklenme Tarihi (Eski)</option>
            </select>

            <div class="col-span-full md:col-span-4 mt-4 flex flex-col sm:flex-row gap-4">
                <button id="toggle-form-btn" class="btn btn-primary w-full sm:w-auto"><span id="toggle-form-icon" class="material-symbols-outlined">add</span><span id="toggle-form-text">Yeni Kayıt</span></button>
                <a href="index.html" rel="noopener noreferrer" class="btn btn-secondary w-full sm:w-auto"><span class="material-symbols-outlined">visibility</span><span>Galeriye Git</span></a>
            </div>
        </div>
        
        <div id="add-edit-form-container" class="bg-[var(--md-sys-color-surface-container)] rounded-2xl p-6 mb-8 hidden">
            <h2 id="form-title" class="text-2xl font-bold mb-4">Yeni Kayıt Ekle</h2>
            <form id="add-edit-form" class="flex flex-col gap-3">
                <div id="date-edit-container" class="hidden">
                    <label class="block text-sm font-medium mb-1">Eklenme Tarihi</label>
                    <input type="date" name="eklenmeTarihi" class="form-input">
                </div>

                <select id="item-type-select" class="form-select mb-2"><option value="character">Normal Karakter</option><option value="fusion">Füzyon</option><option value="easterEgg">Easter Egg</option></select>
                <input required type="text" name="id" placeholder="Kayıt ID (benzersiz olmalı)" class="form-input">
                <input required type="text" name="name" placeholder="İsim" class="form-input">
                <div id="main-image-upload-container"><label class="block text-sm font-medium mb-1">Ana Resim</label><input type="file" name="imageFile" class="form-input"></div>
                <div id="character-fields" class="flex flex-col gap-3">
                    <div><label class="block text-sm font-medium mb-1">2★ Resim</label><input type="file" name="evolutions_1_file" class="form-input"></div>
                    <div><label class="block text-sm font-medium mb-1">3★ Resim</label><input type="file" name="evolutions_2_file" class="form-input"></div>
                </div>
                
                <div id="fusion-fields" class="hidden flex flex-col gap-3">
                    <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Partner 1</label>
                        <div class="flex items-center gap-2"><div id="fusionPartners_0_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('fusionPartners_0')">Seç</button><input type="hidden" name="fusionPartners_0"></div>
                    </div>
                     <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Partner 2</label>
                        <div class="flex items-center gap-2"><div id="fusionPartners_1_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('fusionPartners_1')">Seç</button><input type="hidden" name="fusionPartners_1"></div>
                    </div>
                </div>
                <div id="fusion-preview-image-field" class="hidden flex flex-col gap-3">
                    <div><label class="block text-sm font-medium mb-1">Füzyon Önizleme Resmi (PNG/JPG)</label><input type="file" name="fusion_preview_file" class="form-input"></div>
                </div>
                <div id="easter-egg-fields" class="hidden flex flex-col gap-3">
                     <div class="character-selector-wrapper">
                        <label class="block text-sm font-medium mb-1">Orijinal Karakter</label>
                        <div class="flex items-center gap-2"><div id="originalCharacterId_display" class="form-input flex-grow bg-gray-700/50 italic text-gray-400">Seçilmedi</div><button type="button" class="btn btn-secondary" onclick="openCharacterSelector('originalCharacterId')">Seç</button><input type="hidden" name="originalCharacterId"></div>
                    </div>
                </div>
                
                <div class="flex gap-4 mt-4"><button type="button" id="cancel-button" class="btn btn-secondary flex-grow hidden">İptal</button><button type="submit" id="save-button" class="btn btn-primary flex-grow">Kaydet</button></div>
            </form>
        </div>

        <main>
            <h2 class="text-2xl font-bold mb-4">Mevcut Kayıtlar</h2>
            <div id="admin-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            <p id="no-results" class="text-center text-lg mt-8 hidden" style="color: var(--md-sys-color-on-surface-variant);">Hiçbir kayıt bulunamadı.</p>
        </main>
    </div>

    <div id="login-modal" class="modal-backdrop hidden" onclick="closeLoginModal()"><div class="modal-content" onclick="event.stopPropagation()"><button class="icon-button absolute top-2 right-2" onclick="closeLoginModal()" aria-label="Kapat"><span class="material-symbols-outlined">close</span></button><h2 class="text-2xl font-bold mb-4 text-center">Yönetici Girişi</h2><div class="flex flex-col gap-3"><input type="email" id="admin-email" placeholder="E-posta" class="form-input"><input type="password" id="admin-password" placeholder="Şifre" class="form-input"><button id="login-submit-btn" class="btn btn-success w-full mt-2">Giriş Yap</button><p id="login-status" class="mt-2 text-center text-red-400 h-5"></p></div></div></div>
    <div id="enlarged-image-overlay" class="enlarged-image-container hidden" onclick="closeEnlargedImage()"><button class="icon-button absolute top-4 right-4 text-white text-4xl z-10" onclick="closeEnlargedImage(event)" aria-label="Resmi Kapat"><span class="material-symbols-outlined" style="font-size: 36px;">close</span></button><img id="enlarged-image" src="" alt="Büyük Resim" class="enlarged-image"></div>
    
    <div id="character-selector-modal" class="modal-backdrop hidden" onclick="closeCharacterSelector()">
        <div class="modal-content !max-w-screen-sm" onclick="event.stopPropagation()">
            <button class="icon-button absolute top-2 right-2" onclick="closeCharacterSelector()" aria-label="Kapat"><span class="material-symbols-outlined">close</span></button>
            <h2 class="text-2xl font-bold mb-4">Karakter Seç</h2>
            <input type="text" id="selector-search-input" placeholder="Karakter ara..." class="form-input mb-4">
            <div id="selector-grid" class="max-h-96 overflow-y-auto pr-2 flex flex-col gap-2">
            </div>
        </div>
    </div>
    
    <div id="report-modal" class="modal-backdrop hidden" onclick="closeReportModal()">
        <div class="modal-content !max-w-screen-md report-modal-content" onclick="event.stopPropagation()">
            <button class="icon-button absolute top-2 right-2" onclick="closeReportModal()" aria-label="Kapat"><span class="material-symbols-outlined">close</span></button>
            <h2 id="report-title" class="text-2xl font-bold mb-4 text-center" style="color: var(--md-sys-color-primary);">Rapor</h2>
            <div id="report-content" class="max-h-[70vh] overflow-y-auto pr-2"></div>
        </div>
    </div>


    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDrEU_QEuvf960ZPxo29n6x8N9K7yGIkCQ",
            authDomain: "karaktergalerisi-dc337.firebaseapp.com",
            projectId: "karaktergalerisi-dc337",
            storageBucket: "karaktergalerisi-dc337.firebasestorage.app",
            messagingSenderId: "486669559067",
            appId: "1:486669559067:web:20c76a78a41d9bc0bbdfbe"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let apiKeys = { imgbb_main_key: null, imgbb_easteregg_key: null };
        let characters = [], easterEggs = [], dismissed = [], editingItemId = null, editingItemType = null;
        let selectorTargetInput = null;

        const viewState = {
            filter: 'all',
            sortBy: 'name_asc',
        };

        const dom = {};
        Object.assign(dom, {
            appContainer: document.getElementById('app'),
            addEditFormContainer: document.getElementById('add-edit-form-container'),
            toggleFormBtn: document.getElementById('toggle-form-btn'),
            toggleFormText: document.getElementById('toggle-form-text'),
            toggleFormIcon: document.getElementById('toggle-form-icon'),
            addEditForm: document.getElementById('add-edit-form'),
            itemTypeSelect: document.getElementById('item-type-select'),
            formTitle: document.getElementById('form-title'),
            saveButton: document.getElementById('save-button'),
            cancelButton: document.getElementById('cancel-button'),
            adminGrid: document.getElementById('admin-grid'),
            searchInput: document.getElementById('search-input'),
            noResults: document.getElementById('no-results'),
            enlargedImageOverlay: document.getElementById('enlarged-image-overlay'),
            enlargedImage: document.getElementById('enlarged-image'),
            authActionBtn: document.getElementById('auth-action-btn'),
            authActionText: document.getElementById('auth-action-text'),
            authActionIcon: document.getElementById('auth-action-icon'),
            loginModal: document.getElementById('login-modal'),
            loginSubmitBtn: document.getElementById('login-submit-btn'),
            adminEmailInput: document.getElementById('admin-email'),
            adminPasswordInput: document.getElementById('admin-password'),
            loginStatus: document.getElementById('login-status'),
            dateEditContainer: document.getElementById('date-edit-container'),
            characterSelectorModal: document.getElementById('character-selector-modal'),
            selectorSearchInput: document.getElementById('selector-search-input'),
            selectorGrid: document.getElementById('selector-grid'),
            viewFilter: document.getElementById('view-filter'),
            sortBy: document.getElementById('sort-by'),
            reportModal: document.getElementById('report-modal'),
            reportTitle: document.getElementById('report-title'),
            reportContent: document.getElementById('report-content'),
        });
        
        const openLoginModal = () => { dom.loginModal.classList.add('visible'); dom.loginModal.classList.remove('hidden'); };
        const closeLoginModal = () => { dom.loginModal.classList.remove('visible'); dom.loginModal.classList.add('hidden'); };
        const openReportModal = () => { dom.reportModal.classList.add('visible'); dom.reportModal.classList.remove('hidden'); };
        
        const closeReportModal = () => {
            dom.reportModal.classList.remove('visible');
            dom.reportModal.classList.add('hidden');
            dom.viewFilter.value = 'all';
            viewState.filter = 'all';
        };
        
        const getStarEmojis = (isFusion, starCount, iconName = 'star') => {
            const colors = { 1: 'text-orange-400', 2: 'text-slate-400', 3: 'text-amber-400', 4: 'text-fuchsia-400' };
            const starIcon = `<span class="material-symbols-outlined ${colors[isFusion ? 4 : Math.min(starCount, 4)]}" style="font-variation-settings: 'FILL' 1;">${iconName}</span>`;
            return `<div class="flex">${Array(starCount || 1).fill(starIcon).join('')}</div>`;
        };

        function openCharacterSelector(targetId) {
            selectorTargetInput = targetId;
            renderCharacterSelector();
            dom.characterSelectorModal.classList.add('visible');
            dom.characterSelectorModal.classList.remove('hidden');
            dom.selectorSearchInput.focus();
        }

        function closeCharacterSelector() {
            dom.characterSelectorModal.classList.remove('visible');
            dom.characterSelectorModal.classList.add('hidden');
            dom.selectorSearchInput.value = '';
            selectorTargetInput = null;
        }

        function renderCharacterSelector(query = '') {
            dom.selectorGrid.innerHTML = '';
            // ================== BAŞLANGIÇ: FİLTRE GÜNCELLEMESİ ==================
            // Karakter seçme listesinden füzyonları hariç tutan filtre kaldırıldı.
            // Artık hem normal karakterler hem de füzyonlar seçilebilir.
            const searchableChars = characters; 
            // ================== BİTİŞ: FİLTRE GÜNCELLEMESİ ==================
            const filtered = searchableChars.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
            
            if (filtered.length === 0) {
                dom.selectorGrid.innerHTML = `<p class="text-center text-gray-400">Karakter bulunamadı.</p>`;
                return;
            }

            filtered.forEach(char => {
                const item = document.createElement('div');
                item.className = 'character-selector-item';
                item.innerHTML = `
                    <img src="${char.imageUrl}" alt="${char.name}" class="w-12 h-12 object-cover rounded-md flex-shrink-0">
                    <div class="flex-grow">
                        <p class="font-bold">${char.name}</p>
                        <p class="text-sm text-gray-400">ID: ${char.id}</p>
                    </div>
                `;
                item.onclick = () => selectCharacter(char);
                dom.selectorGrid.appendChild(item);
            });
        }

        function selectCharacter(char) {
            if (!selectorTargetInput) return;
            const displayEl = document.getElementById(`${selectorTargetInput}_display`);
            const hiddenInput = document.querySelector(`[name="${selectorTargetInput}"]`);
            
            displayEl.textContent = char.name;
            displayEl.classList.remove('italic', 'text-gray-400');
            hiddenInput.value = char.id;
            
            closeCharacterSelector();
        }
        
        function renderAdminPanel() {
            if (viewState.filter === 'preview-report') {
                const allFusions = characters.filter(c => c.isFusion);
                const hasPreview = [];
                const missingPreview = [];
                allFusions.forEach(fusion => {
                    (fusion.previewUrl && fusion.previewUrl.trim() !== '') ? hasPreview.push(fusion) : missingPreview.push(fusion);
                });
                dom.reportTitle.textContent = 'Füzyon Önizleme Raporu';
                dom.reportContent.innerHTML = `
                    <p class="mb-6 text-gray-400">Bu rapor, aktif 4 yıldızlı füzyon karakterlerinin ana galerideki önizleme resimlerinin durumunu gösterir.</p>
                    <h3><span class="text-green-400">✅ Önizleme Resmi Mevcut (${hasPreview.length} Füzyon)</span></h3>
                    ${hasPreview.length > 0 ? hasPreview.map(f => `<p>- ${f.name}</p>`).join('') : '<p class="text-gray-400">Aktif füzyonların hiçbirinin önizleme resmi yok.</p>'}
                    <h3><span class="text-red-400">⚠️ Önizleme Resmi EKSİK (${missingPreview.length} Füzyon)</span></h3>
                    ${missingPreview.length > 0 ? missingPreview.map(f => `<p class="font-semibold">- ${f.name}</p>`).join('') : '<p class="text-gray-400">Önizleme resmi eksik olan aktif füzyon bulunmuyor. Harika!</p>'}
                `;
                openReportModal();
                return;
            }

            dom.adminGrid.innerHTML = '';
            const query = dom.searchInput.value.toLowerCase().trim();
            let allItems = [...characters, ...easterEggs, ...dismissed];
            
            if (viewState.filter === 'available') {
                const fusionPartnerIds = new Set(characters.filter(c => c.isFusion).flatMap(f => f.fusionPartners));
                allItems = characters.filter(c => !c.isFusion && !fusionPartnerIds.has(c.id));
            }

            const getDate = (item) => item.eklenmeTarihi ? item.eklenmeTarihi.toDate() : new Date(0);
            allItems.sort((a, b) => {
                switch (viewState.sortBy) {
                    case 'date_desc': return getDate(b) - getDate(a);
                    case 'date_asc': return getDate(a) - getDate(b);
                    case 'name_asc': default: return a.name.localeCompare(b.name, 'tr');
                }
            });

            const filteredItems = allItems.filter(item => item.name.toLowerCase().includes(query) || item.id.toLowerCase().includes(query));
            dom.noResults.classList.toggle('hidden', filteredItems.length > 0);
            
            filteredItems.forEach(item => {
                const card = document.createElement('div');
                const isRetired = item.isRetired || false;
                card.className = `item-card ${isRetired ? 'retired' : ''}`;
                const isFusion = item.isFusion, isEasterEgg = item.originalCharacterId, nameClass = isFusion || isEasterEgg ? 'font-fantastical-fusion' : '';
                let imageBlockHtml;
                if(isFusion || isEasterEgg) {
                    imageBlockHtml = `<div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden cursor-zoom-in" onclick="enlargeImage(event, '${item.imageUrl}')"><img src="${item.imageUrl}" alt="${item.name}" class="w-full h-full object-cover"></div>`;
                } else {
                    const evo2 = item.evolutions?.find(e => e.star === 2), evo3 = item.evolutions?.find(e => e.star === 3);
                    const thumbClass = "w-12 h-12 flex-shrink-0 rounded-md overflow-hidden bg-black/20 border border-white/10 flex items-center justify-center", placeholderClass = "text-sm font-bold text-gray-500", imgClass = "w-full h-full object-cover cursor-zoom-in";
                    imageBlockHtml = `<div class="flex items-center gap-3"><div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden cursor-zoom-in" onclick="enlargeImage(event, '${item.imageUrl}')"><img src="${item.imageUrl}" alt="${item.name} 1★" class="${imgClass}"></div><div class="flex flex-col gap-1.5"><div class="${thumbClass}" onclick="${evo2 ? `enlargeImage(event, '${evo2.imageUrl}')` : ''}">${evo2 ? `<img src="${evo2.imageUrl}" alt="${item.name} 2★" class="${imgClass}">` : `<span class="${placeholderClass}">2★</span>`}</div><div class="${thumbClass}" onclick="${evo3 ? `enlargeImage(event, '${evo3.imageUrl}')` : ''}">${evo3 ? `<img src="${evo3.imageUrl}" alt="${item.name} 3★" class="${imgClass}">` : `<span class="${placeholderClass}">3★</span>`}</div></div></div>`;
                }
                let starHtml;
                if(isFusion) starHtml = getStarEmojis(true, 4); else if (isEasterEgg) starHtml = getStarEmojis(false, 1, 'auto_awesome'); else starHtml = getStarEmojis(false, 1);
                let actionButtonsHtml;
                if (isRetired) {
                    actionButtonsHtml = `<button class="icon-button retire-button" data-id="${item.id}" data-type="${item.type}" data-action="unretire" aria-label="Geri Al"><span class="material-symbols-outlined">settings_backup_restore</span></button><button class="icon-button delete-button" data-id="${item.id}" data-type="${item.type}" aria-label="Kalıcı Olarak Sil"><span class="material-symbols-outlined">delete_forever</span></button>`;
                } else {
                    actionButtonsHtml = `<button class="icon-button retire-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" data-action="retire" aria-label="Emekliye Ayır"><span class="material-symbols-outlined">work_history</span></button><button class="icon-button edit-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" aria-label="Düzenle"><span class="material-symbols-outlined">edit</span></button><button class="icon-button delete-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" aria-label="Sil"><span class="material-symbols-outlined">delete</span></button>`;
                }
                const retiredBadge = isRetired ? `<p class="text-xs font-bold mt-1" style="color: var(--md-sys-color-warning);">EMEKLİ</p>` : '';
                const dateHtml = item.eklenmeTarihi ? `<p class="text-xs text-gray-400 mt-1">${getDate(item).toLocaleDateString('tr-TR')}</p>` : '<p class="text-xs text-red-400 mt-1">Tarih Yok</p>';
                card.innerHTML = `${imageBlockHtml}<div class="flex-grow"><h4 class="font-bold text-lg truncate ${nameClass}">${item.name}</h4><p class="text-sm text-gray-400">ID: ${item.id}</p><div class="flex mt-1">${starHtml}</div>${dateHtml}${retiredBadge}</div><div class="flex-shrink-0 flex flex-col gap-1">${actionButtonsHtml}</div>`;
                dom.adminGrid.appendChild(card);
            });
            setupActionListeners();
        }
        
        function resetForm() {
            dom.addEditForm.reset();
            editingItemId = null; 
            editingItemType = null;
            dom.formTitle.textContent = "Yeni Kayıt Ekle";
            dom.itemTypeSelect.disabled = false;
            dom.addEditForm.elements['id'].readOnly = false;
            dom.saveButton.textContent = "Kaydet";
            dom.cancelButton.classList.add('hidden');
            dom.saveButton.disabled = false;
            const form = dom.addEditForm;
            form.elements['imageFile'].value = '';
            form.elements['evolutions_1_file'].value = '';
            form.elements['evolutions_2_file'].value = '';
            toggleFormFields();
            document.getElementById('temp-url-container')?.remove();
            ['imageFile', 'evolutions_1_file', 'evolutions_2_file', 'fusion_preview_file'].forEach(name => {
                const el = form.querySelector(`[name="${name}"]`);
                if(el) el.parentElement.style.display = 'block';
            });
            dom.dateEditContainer.classList.add('hidden');
            ['fusionPartners_0', 'fusionPartners_1', 'originalCharacterId'].forEach(id => {
                const display = document.getElementById(`${id}_display`);
                const input = document.querySelector(`[name="${id}"]`);
                if (display) {
                    display.textContent = 'Seçilmedi';
                    display.classList.add('italic', 'text-gray-400');
                }
                if (input) input.value = '';
            });
        }
        
        function updateAuthUI(user) {
            const contentToLock = [dom.appContainer.querySelector('main'), dom.toggleFormBtn.closest('.flex.sm\\:flex-row'), dom.addEditFormContainer, dom.viewFilter, dom.sortBy, dom.searchInput];
            if (user) {
                dom.authActionText.textContent = 'Çıkış Yap';
                dom.authActionIcon.textContent = 'logout';
                dom.authActionBtn.onclick = () => { if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) firebase.auth().signOut(); };
                closeLoginModal();
                fetchApiKeys().then(success => contentToLock.forEach(el => { if(el) { el.style.opacity = success ? '1' : '0.5'; el.style.pointerEvents = success ? 'auto' : 'none'; }}));
            } else {
                dom.authActionText.textContent = 'Giriş Yap';
                dom.authActionIcon.textContent = 'login';
                dom.authActionBtn.onclick = openLoginModal;
                apiKeys = { imgbb_main_key: null, imgbb_easteregg_key: null };
                contentToLock.forEach(el => { if(el) { el.style.opacity = '0.5'; el.style.pointerEvents = 'none'; }});
                dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt'; dom.toggleFormIcon.textContent = 'add';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            fetchItems();
            dom.loginSubmitBtn.addEventListener('click', async () => {
                const email = dom.adminEmailInput.value; const password = dom.adminPasswordInput.value;
                dom.loginStatus.textContent = '';
                try {
                    dom.loginSubmitBtn.disabled = true; dom.loginSubmitBtn.textContent = 'Giriş yapılıyor...';
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                } catch (error) { dom.loginStatus.textContent = `Hata: ${error.code}`;
                } finally { dom.loginSubmitBtn.disabled = false; dom.loginSubmitBtn.textContent = 'Giriş Yap'; }
            });
            firebase.auth().onAuthStateChanged(updateAuthUI);
            dom.itemTypeSelect.addEventListener('change', toggleFormFields);
            dom.addEditForm.addEventListener('submit', handleFormSubmit);
            dom.cancelButton.addEventListener('click', () => {
                resetForm();
                dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt'; dom.toggleFormIcon.textContent = 'add';
            });
            
            dom.searchInput.addEventListener('input', renderAdminPanel);
            dom.viewFilter.addEventListener('change', (e) => {
                viewState.filter = e.target.value;
                renderAdminPanel();
            });
            dom.sortBy.addEventListener('change', (e) => {
                viewState.sortBy = e.target.value;
                renderAdminPanel();
            });

            dom.toggleFormBtn.addEventListener('click', () => {
                const isHidden = dom.addEditFormContainer.classList.toggle('hidden');
                dom.toggleFormText.textContent = isHidden ? 'Yeni Kayıt' : 'Formu Kapat';
                dom.toggleFormIcon.textContent = isHidden ? 'add' : 'close';
                if(isHidden) resetForm();
            });
            
            dom.selectorSearchInput.addEventListener('input', () => renderCharacterSelector(dom.selectorSearchInput.value));
        });

        const toggleFormFields = function() {
            const selectedType = dom.itemTypeSelect.value;
            dom.addEditForm.querySelector('#character-fields').classList.toggle('hidden', selectedType !== 'character');
            dom.addEditForm.querySelector('#fusion-fields').classList.toggle('hidden', selectedType !== 'fusion');
            dom.addEditForm.querySelector('#fusion-preview-image-field').classList.toggle('hidden', selectedType !== 'fusion');
            dom.addEditForm.querySelector('#easter-egg-fields').classList.toggle('hidden', selectedType !== 'easterEgg');
            dom.addEditForm.querySelector('[name="imageFile"]').parentElement.querySelector('label').textContent = selectedType === 'easterEgg' ?
                'Easter Egg Resim' : (selectedType === 'fusion' ? 'Ana Füzyon Resmi (GIF)' : 'Ana Resim');
        };

        const setupActionListeners = function() {
            dom.adminGrid.querySelectorAll('.edit-button, .delete-button, .retire-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { id, type, action } = e.currentTarget.dataset;
                    if (button.classList.contains('edit-button')) {
                        loadItemForEdit(id, type);
                    } else if (button.classList.contains('delete-button')) {
                        deleteItem(id, type);
                    } else if (button.classList.contains('retire-button')) {
                        if (action === 'retire') {
                            retireItem(id, type);
                        } else if (action === 'unretire') {
                            unretireItem(id, type);
                        }
                    }
                });
            });
        };

        const loadItemForEdit = function(itemId, itemType) {
            resetForm();
            const allItems = [...characters, ...easterEggs, ...dismissed];
            const itemData = allItems.find(i => i.id === itemId);
            if (!itemData) return alert("Kayıt bulunamadı.");
            
            editingItemId = itemId;
            editingItemType = itemType;
            dom.formTitle.textContent = "Kaydı Düzenle";
            dom.itemTypeSelect.value = itemType;
            dom.itemTypeSelect.disabled = true;
            
            const form = dom.addEditForm;
            form.elements['id'].value = itemId;
            form.elements['id'].readOnly = true; 
            form.elements['name'].value = itemData.name || '';

            if (itemData.eklenmeTarihi) {
                const date = itemData.eklenmeTarihi.toDate();
                const formattedDate = date.getFullYear() + '-' + ('0' + (date.getMonth() + 1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
                form.elements['eklenmeTarihi'].value = formattedDate;
            } else {
                form.elements['eklenmeTarihi'].value = '';
            }
            dom.dateEditContainer.classList.remove('hidden');
            
            ['imageFile', 'evolutions_1_file', 'evolutions_2_file', 'fusion_preview_file'].forEach(name => {
                if(form.querySelector(`[name="${name}"]`)) form.querySelector(`[name="${name}"]`).parentElement.style.display = 'none';
            });
            
            const urlContainer = document.createElement('div');
            urlContainer.id = 'temp-url-container';
            urlContainer.className = 'flex flex-col gap-3';
            
            const createUrlInput = (name, placeholder, value) => `<input type="text" name="${name}" placeholder="${placeholder}" class="form-input" value="${value || ''}">`;
            
            let inputsHtml = createUrlInput('imageUrl', 'Ana Resim URL', itemData.imageUrl);
            
            if (itemType === 'character') {
                inputsHtml += createUrlInput('evolutions_1', '2★ Resim URL', itemData.evolutions?.find(e=>e.star===2)?.imageUrl);
                inputsHtml += createUrlInput('evolutions_2', '3★ Resim URL', itemData.evolutions?.find(e=>e.star===3)?.imageUrl);
            }
            
            if (itemType === 'fusion') {
                inputsHtml += createUrlInput('previewUrl', 'Önizleme Resmi URL', itemData.previewUrl);
            }

            urlContainer.innerHTML = inputsHtml;
            form.insertBefore(urlContainer, form.querySelector('#character-fields'));

            const updateSelectorDisplay = (inputId, charId) => {
                const character = [...characters, ...dismissed].find(c => c.id === charId);
                const display = document.getElementById(`${inputId}_display`);
                const input = document.querySelector(`[name="${inputId}"]`);
                if (character && display && input) {
                    display.textContent = character.name;
                    display.classList.remove('italic', 'text-gray-400');
                    input.value = character.id;
                }
            };

            if (itemType === 'fusion') {
                updateSelectorDisplay('fusionPartners_0', itemData.fusionPartners?.[0]);
                updateSelectorDisplay('fusionPartners_1', itemData.fusionPartners?.[1]);
            } else if (itemType === 'easterEgg') {
                updateSelectorDisplay('originalCharacterId', itemData.originalCharacterId);
            }
            
            dom.saveButton.textContent = "Güncelle";
            dom.cancelButton.classList.remove('hidden');
            toggleFormFields();
            dom.addEditFormContainer.classList.remove('hidden');
            dom.toggleFormText.textContent = 'Formu Kapat';
            dom.toggleFormIcon.textContent = 'close';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        const uploadImageToImgBB = async function(file, apiKey) {
            if (!file) return null;
            if (!apiKey) { alert("API anahtarı eksik."); throw new Error("API anahtarı eksik."); }
            const formData = new FormData(); formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
                if (!res.ok) throw new Error(`Yükleme hatası: ${res.statusText}`);
                const result = await res.json();
                if (result.success) return result.data.url; else throw new Error(result.error.message);
            } catch (error) { alert(`Resim yüklenemedi: ${error.message}`); return null; }
        };

        const handleFormSubmit = async function(event) {
            event.preventDefault();
            const form = dom.addEditForm;
            const id = form.elements['id'].value.trim();
            if (!id || !firebase.auth().currentUser) return alert(!id ? "ID boş olamaz." : "Giriş yapmalısınız.");
            
            const isEditing = !!editingItemId;
            dom.saveButton.textContent = 'Yükleniyor...';
            dom.saveButton.disabled = true;

            try {
                const type = dom.itemTypeSelect.value;
                let data = { name: form.elements['name'].value.trim() };
                let collectionName = type === 'easterEgg' ? 'easterEggs' : 'characters';

                if (isEditing) {
                    const dateValue = form.elements['eklenmeTarihi'].value;
                    if (dateValue) {
                         const [year, month, day] = dateValue.split('-').map(Number);
                         const localDate = new Date(year, month - 1, day);
                         data.eklenmeTarihi = firebase.firestore.Timestamp.fromDate(localDate);
                    }
                } else {
                    data.eklenmeTarihi = firebase.firestore.FieldValue.serverTimestamp();
                }

                if (type === 'character') {
                    data.isFusion = false;
                    data.star = 1;
                    data.evolutions = [];
                    if (isEditing) {
                        data.imageUrl = form.elements['imageUrl'].value.trim();
                        const evo1Url = form.elements['evolutions_1']?.value.trim();
                        const evo2Url = form.elements['evolutions_2']?.value.trim();
                        if (evo1Url) data.evolutions.push({ star: 2, imageUrl: evo1Url });
                        if (evo2Url) data.evolutions.push({ star: 3, imageUrl: evo2Url });
                    } else {
                        const mainFile = form.elements['imageFile']?.files[0];
                        if (!mainFile) throw new Error("Ana resim seçmek zorunludur.");
                        const [evo1File, evo2File] = [form.elements['evolutions_1_file']?.files[0], form.elements['evolutions_2_file']?.files[0]];
                        const [mainUrl, evo1Url, evo2Url] = await Promise.all([
                            uploadImageToImgBB(mainFile, apiKeys.imgbb_main_key),
                            uploadImageToImgBB(evo1File, apiKeys.imgbb_main_key),
                            uploadImageToImgBB(evo2File, apiKeys.imgbb_main_key)
                        ]);
                        if (!mainUrl) throw new Error("Ana resim yüklenemedi.");
                        data.imageUrl = mainUrl;
                        if (evo1Url) data.evolutions.push({ star: 2, imageUrl: evo1Url });
                        if (evo2Url) data.evolutions.push({ star: 3, imageUrl: evo2Url });
                    }
                } else if (type === 'fusion') {
                    data.isFusion = true;
                    data.star = 4;
                    data.fusionPartners = [form.elements['fusionPartners_0'].value.trim(), form.elements['fusionPartners_1'].value.trim()].filter(Boolean);
                    
                    if (isEditing) {
                        data.imageUrl = form.elements['imageUrl'].value.trim();
                        data.previewUrl = form.elements['previewUrl'].value.trim() || null;
                    } else {
                        const mainFile = form.elements['imageFile']?.files[0];
                        const previewFile = form.elements['fusion_preview_file']?.files[0];
                        if (!mainFile) throw new Error("Ana Füzyon Resmi (GIF) seçmek zorunludur.");
                        
                        const [mainUrl, previewUrl] = await Promise.all([
                            uploadImageToImgBB(mainFile, apiKeys.imgbb_main_key),
                            uploadImageToImgBB(previewFile, apiKeys.imgbb_main_key)
                        ]);
                        if (!mainUrl) throw new Error("Ana GIF yüklenemedi.");
                        data.imageUrl = mainUrl;
                        data.previewUrl = previewUrl || null;
                    }
                } else if (type === 'easterEgg') {
                    data.originalCharacterId = form.elements['originalCharacterId'].value.trim();
                    if (isEditing) {
                        data.imageUrl = form.elements['imageUrl'].value.trim();
                    } else {
                        const mainFile = form.elements['imageFile']?.files[0];
                        if (!mainFile) throw new Error("Easter Egg resmi seçmek zorunludur.");
                        data.imageUrl = await uploadImageToImgBB(mainFile, apiKeys.imgbb_easteregg_key);
                        if (!data.imageUrl) throw new Error("Easter Egg resmi yüklenemedi.");
                    }
                }

                await db.collection(collectionName).doc(id).set(data, { merge: true });
                alert(`Kayıt başarıyla ${isEditing ? 'güncellendi' : 'kaydedildi'}!`);
                await fetchItems();
                dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt';
                dom.toggleFormIcon.textContent = 'add';
                resetForm();
            } catch (error) {
                alert(`Hata: ${error.message}`);
            } finally {
                dom.saveButton.textContent = isEditing ? 'Güncelle' : 'Kaydet';
                dom.saveButton.disabled = false;
            }
        };

        const deleteItem = async function(itemId, itemType) {
            const isRetired = dismissed.some(i => i.id === itemId);
            const collectionName = isRetired ? 'dismissed' : (itemType === 'easterEgg' ? 'easterEggs' : 'characters');
            const item = [...characters, ...easterEggs, ...dismissed].find(i => i.id === itemId);
            if (!item || !confirm(`'${item.name}' adlı kaydı ${isRetired ? 'KALICI OLARAK' : ''} silmek istediğinizden emin misiniz?`)) return;
            try {
                if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");
                await db.collection(collectionName).doc(itemId).delete();
                alert("Kayıt silindi.");
                await fetchItems();
            } catch (error) { alert(`Silme hatası: ${error.message}`); }
        };

        const retireItem = async function(itemId, itemType) {
            if (!confirm("Bu kaydı emekliye ayırmak istediğinizden emin misiniz? Liste görünümünde kalacak ama düzenlenemeyecektir.")) return;
            if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");
            const sourceCollection = itemType === 'easterEgg' ? 'easterEggs' : 'characters';
            const itemRef = db.collection(sourceCollection).doc(itemId);
            try {
                const doc = await itemRef.get();
                if (!doc.exists) throw new Error("Taşınacak kayıt bulunamadı.");
                const itemData = doc.data();
                await db.collection('dismissed').doc(itemId).set({ ...itemData, type: itemType });
                await itemRef.delete();
                alert("Kayıt başarıyla emekliye ayrıldı.");
                await fetchItems();
            } catch (error) { alert(`Emekliye ayırma hatası: ${error.message}`); }
        };

        const unretireItem = async function(itemId, itemType) {
            if (!confirm("Bu kaydı tekrar aktif hale getirmek istediğinizden emin misiniz?")) return;
            if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");
            const dismissedRef = db.collection('dismissed').doc(itemId);
            try {
                const doc = await dismissedRef.get();
                if (!doc.exists) throw new Error("Geri alınacak kayıt bulunamadı.");
                let itemData = doc.data();
                const originalType = itemData.type || 'character';
                const destinationCollection = originalType === 'easterEgg' ? 'easterEggs' : 'characters';
                delete itemData.type;
                await db.collection(destinationCollection).doc(itemId).set(itemData);
                await dismissedRef.delete();
                alert("Kayıt tekrar aktifleştirildi.");
                await fetchItems();
            } catch (error) { alert(`Geri alma hatası: ${error.message}`); }
        };
        
        const fetchItems = async function() {
            try {
                const [charsSnap, eeSnap, dismissedSnap] = await Promise.all([
                    db.collection('characters').get(), 
                    db.collection('easterEggs').get(),
                    db.collection('dismissed').get()
                ]);
                characters = charsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                easterEggs = eeSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                dismissed = dismissedSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), isRetired: true }));
                renderAdminPanel();
            } catch (error) { 
                console.error("Veri çekme hatası:", error);
                dom.adminGrid.innerHTML = `<p class="col-span-full text-center text-lg text-red-500">Veriler çekilemedi. Lütfen konsolu kontrol edin.</p>`;
            }
        };

        const enlargeImage = function(event, src) { if(event) event.stopPropagation(); if(src) {dom.enlargedImage.src = src; dom.enlargedImageOverlay.classList.remove('hidden');} };
        const closeEnlargedImage = function(event) { if (event) event.stopPropagation(); dom.enlargedImageOverlay.classList.add('hidden'); };
        
        const fetchApiKeys = async function() {
            try {
                const apiKeysDoc = await db.collection('settings').doc('apiKeys').get();
                if (apiKeysDoc.exists) { apiKeys = apiKeysDoc.data(); return true; }
                else { alert("Yönetici API anahtarları bulunamadı."); return false; }
            } catch (error) { alert("API anahtarları çekilemedi."); return false; }
        };
    </script>
</body>
</html>
