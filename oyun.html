<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karakter Karşılaştırması</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#443a74"/>
    <script>
        if('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(function() {
                console.log('Service Worker Kaydedildi');
            });
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Metamorphous&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            --md-sys-color-primary-rgb: 189, 179, 255;
            --md-sys-color-primary: rgb(var(--md-sys-color-primary-rgb));
            --md-sys-color-on-primary: #2d235c;
            --md-sys-color-primary-container: #443a74;
            --md-sys-color-background: #131318;
            --md-sys-color-on-background: #e5e1e6;
            --md-sys-color-surface-container: #201f25;
            --md-sys-color-surface-container-high: #2a2830;
            --md-sys-color-on-surface-variant: #c8c4d0;
            --md-sys-color-outline-variant: #48454e;
            --md-sys-color-danger: #ef5350;
            --md-sys-color-gold: #FFD700;
        }
        body { font-family: 'Manrope', sans-serif; background-color: var(--md-sys-color-background); color: var(--md-sys-color-on-background); overflow-x: hidden; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 15% 25%, rgba(var(--md-sys-color-primary-rgb), 0.15) 0%, transparent 40%), radial-gradient(circle at 85% 65%, rgba(140, 179, 255, 0.12) 0%, transparent 45%); z-index: -1; animation: aurora-flow 20s infinite alternate ease-in-out; }
        @keyframes aurora-flow { from { transform: translate(0, 0) rotate(0deg) scale(1.2); } to { transform: translate(5vw, -5vh) rotate(10deg) scale(1.2); } }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: 99px; font-weight: 700; text-decoration: none; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-secondary { background-color: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface-variant); border: 1px solid var(--md-sys-color-outline-variant); }
        .btn-danger { background-color: var(--md-sys-color-danger); color: white; }
        .form-select, .form-input { background-color: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant); color: var(--md-sys-color-on-surface); border-radius: 8px; padding: 12px; width: 100%; transition: all 0.2s ease; }
        
        .screen { min-height: 80vh; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease, transform 0.5s ease; }
        .screen.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; position: absolute; width: 100%; }

        .vs-circle { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border: 4px solid var(--md-sys-color-background); box-shadow: 0 0 20px rgba(var(--md-sys-color-primary-rgb), 0.5); }
        .contestant-card { background-color: var(--md-sys-color-surface-container); border: 3px solid transparent; transition: all 0.3s ease; position: relative; }
        .contestant-card:hover { border-color: var(--md-sys-color-primary); transform: translateY(-8px); box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        .contestant-card.winner-glow { animation: winner-pulse 1s ease-in-out; border-color: var(--md-sys-color-gold); }
        @keyframes winner-pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 10px 20px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
    </style>
</head>
<body class="p-4 sm:p-6">

    <div id="app" class="max-w-screen-xl mx-auto">
        <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center text-center sm:text-left mb-8 pb-4 border-b" style="border-color: var(--md-sys-color-outline-variant);">
            <div class="text-center sm:text-left">
                <h1 class="text-4xl md:text-5xl font-extrabold" style="color: var(--md-sys-color-primary);">Karakter Karşılaştırması</h1>
                <p class="text-lg mt-2" style="color: var(--md-sys-color-on-surface-variant);">En İyiyi Sen Seç</p>
            </div>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-center gap-2 mt-4 sm:mt-0">
                <a href="index.html" class="btn btn-secondary">
                    <span class="material-symbols-outlined">arrow_back</span>
                    <span class="hidden sm:inline">Galeriye Dön</span>
                </a>
                <button id="leaderboard-btn" class="btn btn-secondary">
                    <span class="material-symbols-outlined">leaderboard</span>
                    <span class="hidden sm:inline">Liderlik</span>
                </button>
                <button id="manage-categories-btn" class="btn btn-secondary hidden">
                    <span class="material-symbols-outlined">category</span>
                    <span class="hidden sm:inline">Kategorileri Yönet</span>
                </button>
                <div id="auth-button-container">
                    <button id="auth-action-btn" class="btn btn-secondary">
                        <span id="auth-action-icon" class="material-symbols-outlined">login</span>
                        <span id="auth-action-text">Giriş Yap</span>
                    </button>
                </div>
            </div>
        </header>

        <main id="setup-screen" class="screen">
            <div id="setup-container" class="w-full max-w-lg p-8 rounded-2xl bg-[var(--md-sys-color-surface-container)] shadow-2xl">
                <h2 class="text-2xl font-bold mb-6 text-center">Turnuva Ayarları</h2>
                <form id="setup-form" class="flex flex-col gap-6">
                    <div>
                        <label class="font-semibold mb-2 block">Turnuva Modu</label>
                        <select name="mode" class="form-select">
                            <option value="random">Rastgele Karakterler</option>
                            <option value="all">Tüm Karakterler</option>
                            <option value="stars_1">Sadece 1★ Karakterler</option>
                            <option value="stars_2">Sadece 2★ Karakterler</option>
                            <option value="stars_3">Sadece 3★ Karakterler</option>
                            <option value="fusions">Sadece Füzyonlar (4★)</option>
                            <option value="easter_eggs">Sadece Sırlar (Easter Egg)</option>
                            <option value="absolute_war">MUTLAK SAVAŞ</option>
                        </select>
                    </div>
                    <div id="random-count-container">
                        <label for="char-count" class="font-semibold mb-2 block">Rastgele Karakter Sayısı (En yakın 2'nin katı)</label>
                        <input type="number" name="count" value="16" min="4" max="128" step="2" class="form-select w-full">
                    </div>
                    <div>
                        <label class="font-semibold mb-2 block">Turnuva Kategorisi</label>
                        <div id="category-container" class="grid grid-cols-2 gap-3">
                            </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-full mt-4 text-lg">Turnuvayı Başlat</button>
                </form>
            </div>
            
            <div id="login-prompt" class="hidden text-center p-8 rounded-2xl bg-[var(--md-sys-color-surface-container)] shadow-2xl">
                <span class="material-symbols-outlined text-5xl mb-4" style="color: var(--md-sys-color-primary);">lock</span>
                <h2 class="text-2xl font-bold mb-2">Turnuvayı Görüntülemek İçin Giriş Yapın</h2>
                <p style="color: var(--md-sys-color-on-surface-variant);">Lütfen devam etmek için yukarıdaki "Giriş Yap" butonunu kullanın.</p>
            </div>
        </main>

        <main id="game-screen" class="screen hidden">
             <div class="w-full">
                <div class="text-center mb-6">
                    <h2 id="round-title" class="text-3xl font-bold text-[var(--md-sys-color-primary)]"></h2>
                    <p id="match-info" class="text-lg text-[var(--md-sys-color-on-surface-variant)]"></p>
                    <p id="category-info" class="text-xl font-semibold mt-2"></p>
                </div>
                <div class="flex flex-col md:flex-row items-center justify-center gap-6 md:gap-8 relative">
                    <div id="contestant-1-container" class="w-full max-w-[16rem] sm:max-w-xs md:max-w-sm flex flex-col items-center gap-4">
                        <div id="contestant-1-card" class="contestant-card w-full rounded-2xl overflow-hidden shadow-xl aspect-[2/3] cursor-pointer"><img id="contestant-1-img" src="" class="w-full h-full object-cover"></div>
                        <h3 id="contestant-1-name" class="text-xl md:text-2xl font-bold text-center"></h3>
                    </div>
                    <div class="vs-circle my-2 md:my-0 md:absolute md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 rounded-full w-16 h-16 flex items-center justify-center text-3xl font-bold z-10">VS</div>
                    <div id="contestant-2-container" class="w-full max-w-[16rem] sm:max-w-xs md:max-w-sm flex flex-col items-center gap-4">
                         <div id="contestant-2-card" class="contestant-card w-full rounded-2xl overflow-hidden shadow-xl aspect-[2/3] cursor-pointer"><img id="contestant-2-img" src="" class="w-full h-full object-cover"></div>
                        <h3 id="contestant-2-name" class="text-xl md:text-2xl font-bold text-center"></h3>
                    </div>
                </div>
                <p id="login-to-save-info" class="text-center text-sm mt-4 text-yellow-400 opacity-75 hidden">Kazananları liderlik tablosuna kaydetmek için giriş yapın.</p>
            </div>
        </main>

        <main id="results-screen" class="screen hidden">
            <div class="text-center p-8 rounded-2xl bg-[var(--md-sys-color-surface-container)] shadow-2xl flex flex-col items-center gap-6">
                <h2 id="result-title" class="text-4xl font-bold text-[var(--md-sys-color-gold)]">Turnuva Şampiyonu!</h2>
                <div class="w-56 h-80 sm:w-64 sm:h-96 rounded-2xl overflow-hidden shadow-xl border-4 border-[var(--md-sys-color-gold)]"><img id="winner-img" src="" class="w-full h-full object-cover"></div>
                <h3 id="winner-name" class="text-3xl font-bold"></h3>
                <h4 id="winner-category" class="text-xl text-[var(--md-sys-color-on-surface-variant)]"></h4>
                <button id="play-again-btn" class="btn btn-primary text-lg">Yeni Turnuva</button>
            </div>
        </main>

        <main id="leaderboard-screen" class="screen hidden">
            <div class="w-full max-w-4xl p-8 rounded-2xl bg-[var(--md-sys-color-surface-container)] shadow-2xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">En Çok Kazananlar</h2>
                    <button id="back-to-setup-btn" class="btn btn-secondary">Geri Dön</button>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 items-center justify-between mb-4">
                    <select id="leaderboard-category-select" class="form-select sm:w-auto"></select>
                    <button id="reset-wins-btn" class="btn btn-danger w-full sm:w-auto"><span class="material-symbols-outlined">delete_forever</span>Tüm Galibiyetleri Sıfırla</button>
                </div>
                <div id="leaderboard-content" class="max-h-[60vh] overflow-y-auto"><p>Liderlik tablosu yükleniyor...</p></div>
            </div>
        </main>
    </div>

    <div id="login-modal" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm hidden items-center justify-center" onclick="closeLoginModal()">
        <div class="bg-[var(--md-sys-color-surface-container-high)] rounded-2xl p-8 w-full max-w-sm" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold mb-4 text-center">Giriş Yap</h2>
            <div class="flex flex-col gap-4">
                <input type="email" id="admin-email" placeholder="E-posta" class="form-input">
                <input type="password" id="admin-password" placeholder="Şifre" class="form-input">
                <button id="login-submit-btn" class="btn btn-primary w-full mt-2">Giriş Yap</button>
                <p id="login-status" class="mt-2 text-center text-red-400 h-5"></p>
            </div>
        </div>
    </div>

    <div id="category-modal" class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm hidden items-center justify-center" onclick="closeCategoryModal()">
        <div class="bg-[var(--md-sys-color-surface-container-high)] rounded-2xl p-8 w-full max-w-md" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Kategori Yönetimi</h2>
                <button onclick="closeCategoryModal()" class="btn btn-secondary !rounded-full !p-2"><span class="material-symbols-outlined">close</span></button>
            </div>
            <div class="mb-4">
                <h3 class="font-semibold mb-2">Yeni Kategori Ekle</h3>
                <div class="flex gap-2">
                    <input type="text" id="new-category-input" placeholder="Yeni kategori adı..." class="form-input flex-grow">
                    <button id="add-category-btn" class="btn btn-primary">Ekle</button>
                </div>
            </div>
            <div>
                <h3 class="font-semibold mb-2">Mevcut Kategoriler</h3>
                <div id="category-list" class="max-h-60 overflow-y-auto flex flex-col gap-2">
                    </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDrEU_QEuvf960ZPxo29n6x8N9K7yGIkCQ",
            authDomain: "karaktergalerisi-dc337.firebaseapp.com",
            projectId: "karaktergalerisi-dc337",
            storageBucket: "karaktergalerisi-dc337.firebasestorage.app",
            messagingSenderId: "486669559067",
            appId: "1:486669559067:web:20c76a78a41d9bc0bbdfbe"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const dom = {};
        const screens = ['setup', 'game', 'results', 'leaderboard'];
        let allCharacters = [];
        let gameState = {};

        function showScreen(screenId) {
            screens.forEach(id => document.getElementById(`${id}-screen`).classList.add('hidden'));
            document.getElementById(`${screenId}-screen`).classList.remove('hidden');
        }
        
        // DEĞİŞİKLİK 2: Fonksiyon giriş yapan/yapmayan kullanıcıya göre arayüzü tamamen değiştiriyor
        function updateAuthUI(user) {
            if (user) {
                // Giriş yapmış kullanıcı
                dom.authActionText.textContent = 'Çıkış Yap';
                dom.authActionIcon.textContent = 'logout';
                dom.authActionBtn.onclick = () => auth.signOut();
                dom.loginToSaveInfo.classList.add('hidden');
                dom.resetWinsBtn.disabled = false;
                dom.manageCategoriesBtn.classList.remove('hidden');

                // Ayar ekranını göster, giriş uyarısını gizle
                dom.setupContainer.style.display = 'block';
                dom.loginPrompt.style.display = 'none';

            } else {
                // Giriş yapmamış kullanıcı
                dom.authActionText.textContent = 'Giriş Yap';
                dom.authActionIcon.textContent = 'login';
                dom.authActionBtn.onclick = openLoginModal;
                dom.loginToSaveInfo.classList.remove('hidden');
                dom.resetWinsBtn.disabled = true;
                dom.manageCategoriesBtn.classList.add('hidden');

                // Ayar ekranını gizle, giriş uyarısını göster
                dom.setupContainer.style.display = 'none';
                dom.loginPrompt.style.display = 'block';
            }
        }

        function openLoginModal() { dom.loginModal.classList.add('flex'); dom.loginModal.classList.remove('hidden'); }
        function closeLoginModal() { dom.loginModal.classList.add('hidden'); dom.loginModal.classList.remove('flex'); }
        
        function openCategoryModal() {
            dom.categoryModal.classList.add('flex');
            dom.categoryModal.classList.remove('hidden');
            loadCategoriesForManagement();
        }

        function closeCategoryModal() {
            dom.categoryModal.classList.add('hidden');
            dom.categoryModal.classList.remove('flex');
        }

        async function loadCategoriesFromFirestore() {
            try {
                const snapshot = await db.collection('categories').orderBy('name').get();
                const categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                dom.categoryContainer.innerHTML = '';
                if (categories.length > 0) {
                    categories.forEach((cat, index) => {
                        const label = document.createElement('label');
                        label.className = "flex items-center gap-3 p-3 rounded-lg bg-[var(--md-sys-color-surface-container-high)]";
                        const input = document.createElement('input');
                        input.type = 'radio';
                        input.name = 'category';
                        input.value = cat.name;
                        if (index === 0) input.checked = true;
                        label.appendChild(input);
                        label.append(` ${cat.name}`);
                        dom.categoryContainer.appendChild(label);
                    });
                } else {
                    dom.categoryContainer.innerHTML = '<p>Henüz kategori eklenmemiş.</p>';
                }

                dom.leaderboardCategorySelect.innerHTML = categories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');

            } catch (error) {
                console.error("Kategoriler yüklenemedi:", error);
                dom.categoryContainer.innerHTML = '<p class="text-red-500">Kategoriler yüklenirken bir hata oluştu.</p>';
            }
        }

        async function loadCategoriesForManagement() {
            const list = dom.categoryList;
            list.innerHTML = '<p>Yükleniyor...</p>';
            const snapshot = await db.collection('categories').orderBy('name').get();
            const categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            list.innerHTML = '';
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-[var(--md-sys-color-surface-container)] rounded';
                item.innerHTML = `<span>${cat.name}</span>`;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger !p-2 !rounded-full';
                deleteBtn.innerHTML = `<span class="material-symbols-outlined">delete</span>`;
                deleteBtn.onclick = () => deleteCategory(cat.id, cat.name);
                
                item.appendChild(deleteBtn);
                list.appendChild(item);
            });
        }

        async function addCategory() {
            const name = dom.newCategoryInput.value.trim();
            if (!name) return;
            
            try {
                await db.collection('categories').add({ name: name });
                dom.newCategoryInput.value = '';
                await loadCategoriesFromFirestore();
                await loadCategoriesForManagement();
            } catch (error) {
                console.error("Kategori eklenemedi: ", error);
            }
        }

        async function deleteCategory(id, name) {
            if (!confirm(`'${name}' kategorisini silmek istediğinizden emin misiniz?`)) return;
            
            try {
                await db.collection('categories').doc(id).delete();
                await loadCategoriesFromFirestore();
                await loadCategoriesForManagement();
            } catch (error) {
                console.error("Kategori silinemedi: ", error);
            }
        }

        function prepareContestants(settings) {
            let contestants = [];
            const addContestant = (char, star) => {
                let imageUrl = char.imageUrl;
                if (star > 1) {
                    const evo = char.evolutions?.find(e => e.star === star);
                    if (!evo) return;
                    imageUrl = evo.imageUrl;
                }
                contestants.push({ id: `${char.id}_${star}`, name: `${char.name} (${star}★)`, imageUrl: imageUrl });
            };
            const addFusionContestant = (char) => {
                contestants.push({ id: char.id, name: `${char.name} (4★)`, imageUrl: char.imageUrl });
            };

            const sourceList = allCharacters.filter(c => !c.isDismissed && !c.isEasterEgg);
            const easterEggList = allCharacters.filter(c => c.isEasterEgg);

            switch (settings.mode) {
                case 'all':
                    sourceList.forEach(char => {
                        if (char.isFusion) addFusionContestant(char);
                        else { [1, 2, 3].forEach(star => addContestant(char, star)); }
                    });
                    break;
                case 'fusions':
                    sourceList.filter(c => c.isFusion).forEach(addFusionContestant);
                    break;
                case 'easter_eggs':
                     easterEggList.forEach(char => contestants.push({ id: char.id, name: `${char.name} (Sır)`, imageUrl: char.imageUrl }));
                    break;
                case 'random':
                    let allPossible = [];
                     sourceList.forEach(char => {
                        if (char.isFusion) allPossible.push({ id: char.id, name: `${char.name} (4★)`, imageUrl: char.imageUrl });
                        else { 
                            [1, 2, 3].forEach(star => {
                                const evo = star > 1 ? char.evolutions?.find(e => e.star === star) : true;
                                if (evo) allPossible.push({ id: `${char.id}_${star}`, name: `${char.name} (${star}★)`, imageUrl: star > 1 ? evo.imageUrl : char.imageUrl });
                            });
                        }
                    });
                    allPossible.sort(() => Math.random() - 0.5);
                    contestants = allPossible.slice(0, settings.count);
                    break;
                default:
                    const star = parseInt(settings.mode.split('_')[1]);
                    sourceList.filter(c => !c.isFusion).forEach(char => addContestant(char, star));
                    break;
            }
            const powerOfTwo = Math.pow(2, Math.floor(Math.log2(contestants.length)));
            return contestants.slice(0, powerOfTwo);
        }
        
        function startGame(settings) {
            gameState.settings = settings;
            if (settings.mode === 'absolute_war') {
                gameState.absoluteWar = { stage: 1, winners: [] };
                startAbsoluteWarStage();
                return;
            }
            const contestants = prepareContestants(settings);
            if (contestants.length < 2) {
                alert("Turnuva için yeterli karakter bulunamadı! (En az 2 gerekli)");
                return;
            }
            contestants.sort(() => Math.random() - 0.5);
            gameState.contestants = contestants;
            gameState.round = 1;
            gameState.match = 0;
            gameState.winners = [];
            showScreen('game');
            startRound();
        }

        function startAbsoluteWarStage() {
            const stage = gameState.absoluteWar.stage;
            let contestants, stageName;
            if (stage <= 3) { stageName = `${stage}★ Savaşı`; contestants = prepareContestants({mode: `stars_${stage}`}); }
            else if (stage === 4) { stageName = "Füzyonlar Savaşı"; contestants = prepareContestants({mode: 'fusions'}); }
            else { stageName = "ŞAMPİYONLAR FİNALİ"; contestants = gameState.absoluteWar.winners; }

            if (contestants.length < 2) {
                if (stage < 5) { gameState.absoluteWar.stage++; startAbsoluteWarStage(); }
                else { alert("Mutlak Savaş için hiç yarışmacı bulunamadı!"); showScreen('setup'); }
                return;
            }
            contestants.sort(() => Math.random() - 0.5);
            gameState.currentStageName = stageName;
            gameState.contestants = contestants;
            gameState.round = 1;
            gameState.match = 0;
            gameState.winners = [];
            showScreen('game');
            startRound();
        }
        
        function startRound() {
            const { round, match, contestants } = gameState;
            const totalMatches = contestants.length / 2;
            let roundName = totalMatches === 1 ? "FİNAL" : totalMatches === 2 ? "Yarı Final" : totalMatches === 4 ? "Çeyrek Final" : `Tur ${round}`;
            dom.roundTitle.textContent = gameState.settings.mode === 'absolute_war' ? `${gameState.currentStageName} - ${roundName}` : roundName;
            dom.matchInfo.textContent = `Karşılaşma ${match + 1} / ${totalMatches}`;
            
            const checkedCategoryRadio = dom.setupForm.querySelector(`input[name="category"]:checked`);
            if (checkedCategoryRadio) {
                 const categoryText = checkedCategoryRadio.parentElement.textContent.trim();
                 dom.categoryInfo.textContent = `Kategori: ${categoryText}`;
            } else {
                 dom.categoryInfo.textContent = `Kategori: Seçilmedi`;
            }
           
            showPairing();
        }

        function showPairing() {
            [dom.c1_card, dom.c2_card].forEach(card => {
                card.style.pointerEvents = 'auto';
                card.classList.remove('winner-glow');
            });
            const { match, contestants } = gameState;
            const [p1, p2] = [contestants[match * 2], contestants[match * 2 + 1]];
            gameState.currentPair = [p1, p2];
            dom.c1_img.src = p1.imageUrl; dom.c1_name.textContent = p1.name;
            dom.c2_img.src = p2.imageUrl; dom.c2_name.textContent = p2.name;
        }
        
        function castVote(winnerIndex) {
            [dom.c1_card, dom.c2_card].forEach(card => card.style.pointerEvents = 'none');
            const winnerCard = winnerIndex === 0 ? dom.c1_card : dom.c2_card;
            winnerCard.classList.add('winner-glow');

            const winner = gameState.currentPair[winnerIndex];
            gameState.winners.push(winner);

            if (auth.currentUser) {
                saveWinToFirestore(winner, gameState.settings.category);
            }

            setTimeout(() => {
                gameState.match++;
                if (gameState.match * 2 < gameState.contestants.length) {
                    startRound();
                } else {
                    if (gameState.winners.length === 1) {
                        if (gameState.settings.mode === 'absolute_war' && gameState.absoluteWar.stage < 5) {
                            gameState.absoluteWar.winners.push(gameState.winners[0]);
                            gameState.absoluteWar.stage++;
                            startAbsoluteWarStage();
                        } else {
                            showWinner(gameState.winners[0]);
                        }
                    } else {
                        gameState.contestants = gameState.winners;
                        gameState.winners = [];
                        gameState.round++;
                        gameState.match = 0;
                        startRound();
                    }
                }
            }, 1200);
        }
        
        async function saveWinToFirestore(character, category) {
            if (!auth.currentUser) return;
            const winData = {
                userId: auth.currentUser.uid,
                characterId: character.id,
                characterName: character.name,
                category: category,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            };
            try { await db.collection('wins').add(winData); }
            catch (error) { console.error("Galibiyet kaydedilemedi: ", error); }
        }

        function showWinner(winner) {
            dom.winnerImg.src = winner.imageUrl;
            dom.winnerName.textContent = winner.name;
            dom.resultTitle.textContent = gameState.settings.mode === 'absolute_war' ? "MUTLAK SAVAŞ ŞAMPİYONU!" : "Turnuva Şampiyonu!";
            const checkedCategoryRadio = dom.setupForm.querySelector(`input[name="category"]:checked`);
            if(checkedCategoryRadio) {
                const categoryText = checkedCategoryRadio.parentElement.textContent.trim();
                dom.winnerCategory.textContent = `${categoryText} Kategorisi`;
            }
            showScreen('results');
        }

        async function fetchAndDisplayWinLeaderboard() {
            const category = dom.leaderboardCategorySelect.value;
            if (!category) {
                 dom.leaderboardContent.innerHTML = '<p>Lütfen bir kategori seçin.</p>';
                return;
            }
            dom.leaderboardContent.innerHTML = '<p>Galibiyetler hesaplanıyor...</p>';

            try {
                const winsSnapshot = await db.collection('wins').where('category', '==', category).get();
                if (winsSnapshot.empty) {
                    dom.leaderboardContent.innerHTML = '<p>Bu kategoride henüz galibiyet kaydedilmemiş.</p>';
                    return;
                }
                const winCounts = {};
                winsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const charId = data.characterId;
                    if (!winCounts[charId]) {
                        winCounts[charId] = { name: data.characterName, wins: 0 };
                    }
                    winCounts[charId].wins++;
                });
                const leaderboard = Object.values(winCounts).sort((a, b) => b.wins - a.wins);

                let html = '<div class="flex flex-col gap-3">';
                leaderboard.forEach((char, index) => {
                    html += `
                        <div class="flex items-center gap-4 p-3 rounded-lg bg-[var(--md-sys-color-surface-container-high)]">
                            <span class="text-xl font-bold w-8 text-center">${index + 1}</span>
                            <span class="flex-grow font-semibold">${char.name}</span>
                            <span class="text-lg font-bold text-[var(--md-sys-color-primary)]">${char.wins} Galibiyet</span>
                        </div>
                    `;
                });
                html += '</div>';
                dom.leaderboardContent.innerHTML = html;
            } catch (error) {
                dom.leaderboardContent.innerHTML = '<p class="text-red-500">Liderlik tablosu yüklenirken bir hata oluştu.</p>';
            }
        }
        
        async function resetWins() {
             if (!auth.currentUser || !confirm("TÜM GALİBİYET KAYITLARINI KALICI OLARAK SİLMEK istediğinizden emin misiniz? Bu işlem geri alınamaz!")) return;
            dom.leaderboardContent.innerHTML = '<p>Galibiyetler siliniyor...</p>';
            try {
                const snapshot = await db.collection('wins').get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                alert("Tüm galibiyet kayıtları sıfırlandı.");
                fetchAndDisplayWinLeaderboard();
            } catch (error) {
                alert("Galibiyetler sıfırlanırken bir hata oluştu.");
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            Object.assign(dom, {
                setupForm: document.getElementById('setup-form'),
                // DEĞİŞİKLİK 2: Yeni DOM elemanları eklendi
                setupContainer: document.getElementById('setup-container'),
                loginPrompt: document.getElementById('login-prompt'),
                randomCountContainer: document.getElementById('random-count-container'),
                roundTitle: document.getElementById('round-title'),
                matchInfo: document.getElementById('match-info'),
                categoryInfo: document.getElementById('category-info'),
                c1_card: document.getElementById('contestant-1-card'), c1_img: document.getElementById('contestant-1-img'), c1_name: document.getElementById('contestant-1-name'),
                c2_card: document.getElementById('contestant-2-card'), c2_img: document.getElementById('contestant-2-img'), c2_name: document.getElementById('contestant-2-name'),
                winnerImg: document.getElementById('winner-img'), winnerName: document.getElementById('winner-name'), resultTitle: document.getElementById('result-title'), winnerCategory: document.getElementById('winner-category'),
                playAgainBtn: document.getElementById('play-again-btn'),
                loginModal: document.getElementById('login-modal'), loginSubmitBtn: document.getElementById('login-submit-btn'), authActionBtn: document.getElementById('auth-action-btn'), authActionText: document.getElementById('auth-action-text'), authActionIcon: document.getElementById('auth-action-icon'),
                loginToSaveInfo: document.getElementById('login-to-save-info'),
                leaderboardBtn: document.getElementById('leaderboard-btn'), backToSetupBtn: document.getElementById('back-to-setup-btn'), leaderboardContent: document.getElementById('leaderboard-content'), leaderboardCategorySelect: document.getElementById('leaderboard-category-select'), resetWinsBtn: document.getElementById('reset-wins-btn'),
                manageCategoriesBtn: document.getElementById('manage-categories-btn'),
                categoryContainer: document.getElementById('category-container'),
                categoryModal: document.getElementById('category-modal'),
                addCategoryBtn: document.getElementById('add-category-btn'),
                newCategoryInput: document.getElementById('new-category-input'),
                categoryList: document.getElementById('category-list'),
            });
            
            await loadCategoriesFromFirestore();

            try {
                const [charsSnap, dismissedSnap, eeSnap] = await Promise.all([db.collection('characters').get(), db.collection('dismissed').get(), db.collection('easterEggs').get()]);
                allCharacters = [...charsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })), ...dismissedSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), isDismissed: true })), ...eeSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), isEasterEgg: true }))];
            } catch (error) { alert("Karakter verileri yüklenemedi."); }

            auth.onAuthStateChanged(updateAuthUI);
            dom.loginSubmitBtn.addEventListener('click', async () => {
                const [email, password, status] = [document.getElementById('admin-email').value, document.getElementById('admin-password').value, document.getElementById('login-status')];
                status.textContent = '';
                try { await auth.signInWithEmailAndPassword(email, password); closeLoginModal(); } catch (error) { status.textContent = `Hata: ${error.code}`; }
            });

            dom.setupForm.addEventListener('submit', (e) => { e.preventDefault(); const fd = new FormData(dom.setupForm); startGame({ mode: fd.get('mode'), count: parseInt(fd.get('count'), 10), category: fd.get('category') }); });
            dom.setupForm.elements['mode'].addEventListener('change', (e) => { dom.randomCountContainer.style.display = e.target.value === 'random' ? 'block' : 'none'; });
            
            const contestantCard1 = document.getElementById('contestant-1-card');
            const contestantCard2 = document.getElementById('contestant-2-card');
            contestantCard1.addEventListener('click', () => castVote(0));
            contestantCard2.addEventListener('click', () => castVote(1));

            dom.playAgainBtn.addEventListener('click', () => showScreen('setup'));
            dom.backToSetupBtn.addEventListener('click', () => showScreen('setup'));
            dom.leaderboardBtn.addEventListener('click', () => {
                fetchAndDisplayWinLeaderboard();
                showScreen('leaderboard');
            });
            dom.leaderboardCategorySelect.addEventListener('change', fetchAndDisplayWinLeaderboard);
            dom.resetWinsBtn.addEventListener('click', resetWins);
            
            dom.manageCategoriesBtn.addEventListener('click', openCategoryModal);
            dom.addCategoryBtn.addEventListener('click', addCategory);

            showScreen('setup');
        });
    </script>
</body>
</html>
