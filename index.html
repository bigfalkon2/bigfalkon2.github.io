<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yönetim Paneli - Gelişmiş Görünüm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Metamorphous&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            --md-sys-color-primary-rgb: 189, 179, 255;
            --md-sys-color-primary: rgb(var(--md-sys-color-primary-rgb));
            --md-sys-color-on-primary: #2d235c;
            --md-sys-color-primary-container: #443a74;
            --md-sys-color-on-primary-container: #e6deff;
            --md-sys-color-background: #131318;
            --md-sys-color-on-background: #e5e1e6;
            --md-sys-color-surface: #1a191f;
            --md-sys-color-surface-container: #201f25;
            --md-sys-color-surface-container-high: #2a2830;
            --md-sys-color-on-surface: #e5e1e6;
            --md-sys-color-on-surface-variant: #c8c4d0;
            --md-sys-color-outline-variant: #48454e;
            --md-sys-color-success-rgb: 102, 187, 106;
            --md-sys-color-success: rgb(var(--md-sys-color-success-rgb));
            --md-sys-color-on-success: #ffffff;
            --md-sys-color-danger-rgb: 239, 83, 80;
            --md-sys-color-danger: rgb(var(--md-sys-color-danger-rgb));
            --md-sys-color-on-danger: #ffffff;
            /* YENİ: Emekli karakterler için renk */
            --md-sys-color-warning-rgb: 255, 183, 77;
            --md-sys-color-warning: rgb(var(--md-sys-color-warning-rgb));
        }
        body { font-family: 'Manrope', sans-serif; background-color: var(--md-sys-color-background); color: var(--md-sys-color-on-background); }
        .form-input { background-color: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant); color: var(--md-sys-color-on-surface); border-radius: 8px; padding: 12px; width: 100%; transition: all 0.2s ease; }
        .form-input:focus { border-color: var(--md-sys-color-primary); box-shadow: 0 0 0 3px rgba(var(--md-sys-color-primary-rgb), 0.2); outline: none; }
        .item-card { display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 16px; background-color: var(--md-sys-color-surface-container); transition: all 0.2s ease-in-out; border: 1px solid var(--md-sys-color-outline-variant); }
        .item-card:hover { transform: translateY(-4px); background-color: var(--md-sys-color-surface-container-high); box-shadow: 0 8px 20px rgba(0,0,0,0.25); }
        /* YENİ: Emekli kartı için stil */
        .item-card.retired { opacity: 0.7; border-left: 4px solid var(--md-sys-color-warning); }
        .item-card.retired:hover { transform: translateY(0); opacity: 0.8; }
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border-radius: 8px; font-weight: 700; text-decoration: none; border: 1px solid transparent; cursor: pointer; transition: all 0.2s ease; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        .btn-success { background-color: var(--md-sys-color-success); color: var(--md-sys-color-on-success); }
        .btn-secondary { background-color: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface-variant); border: 1px solid var(--md-sys-color-outline-variant); }
        .btn-secondary:hover { border-color: var(--md-sys-color-primary); color: var(--md-sys-color-primary); background-color: rgba(var(--md-sys-color-primary-rgb), 0.08); transform: translateY(0); box-shadow: none; }
        .btn-danger { background-color: var(--md-sys-color-danger); color: var(--md-sys-color-on-danger); }
        .icon-button { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; border-radius: 50%; background-color: transparent; color: var(--md-sys-color-on-surface-variant); cursor: pointer; transition: all 0.2s; }
        .icon-button:hover.edit-button { background-color: rgba(var(--md-sys-color-primary-rgb), 0.1); color: var(--md-sys-color-primary); }
        .icon-button:hover.delete-button { background-color: rgba(var(--md-sys-color-danger-rgb), 0.1); color: var(--md-sys-color-danger); }
        /* YENİ: Emekli etme butonu için stil */
        .icon-button:hover.retire-button { background-color: rgba(var(--md-sys-color-warning-rgb), 0.1); color: var(--md-sys-color-warning); }
        .modal-backdrop { z-index: 1000; position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: var(--md-sys-color-surface-container); border-radius: 24px; padding: 2rem; width: 100%; max-width: 400px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .enlarged-image-container { z-index: 1100; position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(0,0,0,0.85); backdrop-filter: blur(5px); }
        .enlarged-image { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div id="app" class="max-w-screen-xl mx-auto">
        <header class="flex justify-between items-center mb-8 pb-4 border-b" style="border-color: var(--md-sys-color-outline-variant);">
            <div>
                <h1 class="text-4xl md:text-5xl font-extrabold" style="color: var(--md-sys-color-primary);">Yönetim Paneli</h1>
                <p class="text-lg mt-2" style="color: var(--md-sys-color-on-surface-variant);">Karakterleri, Füzyonları ve Gizli Sırları Yönet</p>
            </div>
            <div id="auth-button-container">
                <button id="auth-action-btn" class="btn btn-secondary">
                    <span id="auth-action-icon" class="material-symbols-outlined">login</span>
                    <span id="auth-action-text">Giriş Yap</span>
                </button>
            </div>
        </header>
        
        <div class="mb-6 flex flex-col sm:flex-row gap-4 items-center">
            <input type="text" id="search-input" placeholder="Kayıtlar içinde ara..." class="form-input flex-grow">
            <div class="flex gap-2 w-full sm:w-auto">
                <button id="toggle-form-btn" class="btn btn-primary w-full sm:w-auto">
                    <span id="toggle-form-icon" class="material-symbols-outlined">add</span>
                    <span id="toggle-form-text">Yeni Kayıt</span>
                </button>
                <a href="https://bigfalkon.github.io" target="_blank" rel="noopener noreferrer" class="btn btn-secondary">
                    <span class="material-symbols-outlined">visibility</span>
                    <span>Galeriye Git</span>
                </a>
            </div>
        </div>
        
        <div id="add-edit-form-container" class="bg-[var(--md-sys-color-surface-container)] rounded-2xl p-6 mb-8">
            <h2 id="form-title" class="text-2xl font-bold mb-4">Yeni Kayıt Ekle</h2>
            <form id="add-edit-form" class="flex flex-col gap-3">
                <select id="item-type-select" class="form-input mb-2"><option value="character">Normal Karakter</option><option value="fusion">Füzyon</option><option value="easterEgg">Easter Egg</option></select>
                <input required type="text" name="id" placeholder="Kayıt ID (benzersiz olmalı)" class="form-input">
                <input required type="text" name="name" placeholder="İsim" class="form-input">
                <div id="main-image-upload-container"><label class="block text-sm font-medium mb-1">Ana Resim</label><input type="file" name="imageFile" class="form-input"></div>
                <div id="character-fields" class="flex flex-col gap-3">
                    <div><label class="block text-sm font-medium mb-1">2★ Resim</label><input type="file" name="evolutions_1_file" class="form-input"></div>
                    <div><label class="block text-sm font-medium mb-1">3★ Resim</label><input type="file" name="evolutions_2_file" class="form-input"></div>
                </div>
                <div id="fusion-fields" class="hidden flex flex-col gap-3"><input type="text" name="fusionPartners_0" placeholder="Partner 1 ID" class="form-input"><input type="text" name="fusionPartners_1" placeholder="Partner 2 ID" class="form-input"></div>
                <div id="easter-egg-fields" class="hidden flex-col gap-3"><input type="text" name="originalCharacterId" placeholder="Orijinal Karakter ID" class="form-input"></div>
                <div class="flex gap-4 mt-4"><button type="button" id="cancel-button" class="btn btn-secondary flex-grow">İptal</button><button type="submit" id="save-button" class="btn btn-primary flex-grow">Kaydet</button></div>
            </form>
        </div>

        <main>
            <h2 class="text-2xl font-bold mb-4">Mevcut Kayıtlar</h2>
            <div id="admin-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
            <p id="no-results" class="text-center text-lg mt-8 hidden" style="color: var(--md-sys-color-on-surface-variant);">Hiçbir kayıt bulunamadı.</p>
        </main>
    </div>

    <div id="login-modal" class="modal-backdrop hidden" onclick="closeLoginModal()"><div class="modal-content" onclick="event.stopPropagation()"><button class="icon-button absolute top-2 right-2" onclick="closeLoginModal()" aria-label="Kapat"><span class="material-symbols-outlined">close</span></button><h2 class="text-2xl font-bold mb-4 text-center">Yönetici Girişi</h2><div class="flex flex-col gap-3"><input type="email" id="admin-email" placeholder="E-posta" class="form-input"><input type="password" id="admin-password" placeholder="Şifre" class="form-input"><button id="login-submit-btn" class="btn btn-success w-full mt-2">Giriş Yap</button><p id="login-status" class="mt-2 text-center text-red-400 h-5"></p></div></div></div>
    <div id="enlarged-image-overlay" class="enlarged-image-container hidden" onclick="closeEnlargedImage()"><button class="icon-button absolute top-4 right-4 text-white text-4xl z-10" onclick="closeEnlargedImage(event)" aria-label="Resmi Kapat"><span class="material-symbols-outlined" style="font-size: 36px;">close</span></button><img id="enlarged-image" src="" alt="Büyük Resim" class="enlarged-image"></div>

    <script>
        const firebaseConfig = {
  apiKey: "AIzaSyDrEU_QEuvf960ZPxo29n6x8N9K7yGIkCQ",
  authDomain: "karaktergalerisi-dc337.firebaseapp.com",
  projectId: "karaktergalerisi-dc337",
  storageBucket: "karaktergalerisi-dc337.firebasestorage.app",
  messagingSenderId: "486669559067",
  appId: "1:486669559067:web:20c76a78a41d9bc0bbdfbe"
};
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let apiKeys = { imgbb_main_key: null, imgbb_easteregg_key: null };
        // YENİ: Emekli karakterler için yeni bir dizi tanımlandı
        let characters = [], easterEggs = [], dismissed = [], editingItemId = null, editingItemType = null;
        
        const dom = {
            appContainer: document.getElementById('app'),
            addEditFormContainer: document.getElementById('add-edit-form-container'),
            toggleFormBtn: document.getElementById('toggle-form-btn'),
            toggleFormText: document.getElementById('toggle-form-text'),
            toggleFormIcon: document.getElementById('toggle-form-icon'),
            addEditForm: document.getElementById('add-edit-form'),
            itemTypeSelect: document.getElementById('item-type-select'),
            formTitle: document.getElementById('form-title'),
            saveButton: document.getElementById('save-button'),
            cancelButton: document.getElementById('cancel-button'),
            adminGrid: document.getElementById('admin-grid'),
            searchInput: document.getElementById('search-input'),
            noResults: document.getElementById('no-results'),
            enlargedImageOverlay: document.getElementById('enlarged-image-overlay'),
            enlargedImage: document.getElementById('enlarged-image'),
            authActionBtn: document.getElementById('auth-action-btn'),
            authActionText: document.getElementById('auth-action-text'),
            authActionIcon: document.getElementById('auth-action-icon'),
            loginModal: document.getElementById('login-modal'),
            loginSubmitBtn: document.getElementById('login-submit-btn'),
            adminEmailInput: document.getElementById('admin-email'),
            adminPasswordInput: document.getElementById('admin-password'),
            loginStatus: document.getElementById('login-status'),
        };

        const openLoginModal = () => { dom.loginModal.classList.add('visible'); dom.loginModal.classList.remove('hidden'); };
        const closeLoginModal = () => { dom.loginModal.classList.remove('visible'); dom.loginModal.classList.add('hidden'); };
        
        const getStarEmojis = (isFusion, starCount, iconName = 'star') => {
            const colors = { 1: 'text-orange-400', 2: 'text-slate-400', 3: 'text-amber-400', 4: 'text-fuchsia-400' };
            const starIcon = `<span class="material-symbols-outlined ${colors[isFusion ? 4 : Math.min(starCount, 4)]}" style="font-variation-settings: 'FILL' 1;">${iconName}</span>`;
            return `<div class="flex">${Array(starCount || 1).fill(starIcon).join('')}</div>`;
        };

        // YENİ: renderAdminPanel fonksiyonu emekli karakterleri de gösterecek şekilde güncellendi
        function renderAdminPanel() {
            dom.adminGrid.innerHTML = '';
            const query = dom.searchInput.value.toLowerCase().trim();
            // YENİ: Tüm kayıtlar (aktif ve emekli) birleştirilip isme göre sıralanıyor
            const allItems = [...characters, ...easterEggs, ...dismissed].sort((a,b) => a.name.localeCompare(b.name, 'tr'));
            
            const filteredItems = allItems.filter(item => item.name.toLowerCase().includes(query) || item.id.toLowerCase().includes(query));
            dom.noResults.classList.toggle('hidden', filteredItems.length > 0);

            filteredItems.forEach(item => {
                const card = document.createElement('div');
                // YENİ: Emekli ise özel class ekleniyor
                const isRetired = item.isRetired || false;
                card.className = `item-card ${isRetired ? 'retired' : ''}`;

                const isFusion = item.isFusion, isEasterEgg = item.originalCharacterId, nameClass = isFusion || isEasterEgg ? 'font-fantastical-fusion' : '';
                
                let imageBlockHtml;
                if(isFusion || isEasterEgg) {
                    imageBlockHtml = `<div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden cursor-zoom-in" onclick="enlargeImage(event, '${item.imageUrl}')"><img src="${item.imageUrl}" alt="${item.name}" class="w-full h-full object-cover"></div>`;
                } else {
                    const evo2 = item.evolutions?.find(e => e.star === 2), evo3 = item.evolutions?.find(e => e.star === 3);
                    const thumbClass = "w-12 h-12 flex-shrink-0 rounded-md overflow-hidden bg-black/20 border border-white/10 flex items-center justify-center", placeholderClass = "text-sm font-bold text-gray-500", imgClass = "w-full h-full object-cover cursor-zoom-in";
                    imageBlockHtml = `<div class="flex items-center gap-3"><div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden cursor-zoom-in" onclick="enlargeImage(event, '${item.imageUrl}')"><img src="${item.imageUrl}" alt="${item.name} 1★" class="${imgClass}"></div><div class="flex flex-col gap-1.5"><div class="${thumbClass}" onclick="${evo2 ? `enlargeImage(event, '${evo2.imageUrl}')` : ''}">${evo2 ? `<img src="${evo2.imageUrl}" alt="${item.name} 2★" class="${imgClass}">` : `<span class="${placeholderClass}">2★</span>`}</div><div class="${thumbClass}" onclick="${evo3 ? `enlargeImage(event, '${evo3.imageUrl}')` : ''}">${evo3 ? `<img src="${evo3.imageUrl}" alt="${item.name} 3★" class="${imgClass}">` : `<span class="${placeholderClass}">3★</span>`}</div></div></div>`;
                }
                
                let starHtml;
                if(isFusion) starHtml = getStarEmojis(true, 4); else if (isEasterEgg) starHtml = getStarEmojis(false, 1, 'auto_awesome'); else starHtml = getStarEmojis(false, 1);

                // YENİ: Emekli karakterler için farklı buton seti oluşturuluyor
                let actionButtonsHtml;
                if (isRetired) {
                    actionButtonsHtml = `
                        <button class="icon-button retire-button" data-id="${item.id}" data-type="${item.type}" data-action="unretire" aria-label="Geri Al">
                            <span class="material-symbols-outlined">settings_backup_restore</span>
                        </button>
                        <button class="icon-button delete-button" data-id="${item.id}" data-type="${item.type}" aria-label="Kalıcı Olarak Sil">
                            <span class="material-symbols-outlined">delete_forever</span>
                        </button>`;
                } else {
                    actionButtonsHtml = `
                        <button class="icon-button retire-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" data-action="retire" aria-label="Emekliye Ayır">
                            <span class="material-symbols-outlined">work_history</span>
                        </button>
                        <button class="icon-button edit-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" aria-label="Düzenle">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                        <button class="icon-button delete-button" data-id="${item.id}" data-type="${isFusion ? 'fusion' : (isEasterEgg ? 'easterEgg' : 'character')}" aria-label="Sil">
                            <span class="material-symbols-outlined">delete</span>
                        </button>`;
                }

                // YENİ: Emekli ise "Emekli" yazısı ekleniyor
                const retiredBadge = isRetired ? `<p class="text-xs font-bold mt-1" style="color: var(--md-sys-color-warning);">EMEKLİ</p>` : '';

                card.innerHTML = `${imageBlockHtml}
                    <div class="flex-grow">
                        <h4 class="font-bold text-lg truncate ${nameClass}">${item.name}</h4>
                        <p class="text-sm text-gray-400">ID: ${item.id}</p>
                        <div class="flex mt-1">${starHtml}</div>
                        ${retiredBadge}
                    </div>
                    <div class="flex-shrink-0 flex flex-col gap-1">
                        ${actionButtonsHtml}
                    </div>`;
                dom.adminGrid.appendChild(card);
            });
            setupActionListeners(); // Listener fonksiyonunun adı güncellendi
        }
        
        function resetForm() {
            dom.addEditForm.reset(); 
            editingItemId = null; 
            editingItemType = null;
            dom.formTitle.textContent = "Yeni Kayıt Ekle";
            dom.itemTypeSelect.disabled = false;
            dom.addEditForm.elements['id'].readOnly = false;
            dom.saveButton.textContent = "Kaydet";
            dom.cancelButton.classList.add('hidden');
            dom.saveButton.disabled = false;
            const form = dom.addEditForm;
            form.elements['imageFile'].value = '';
            form.elements['evolutions_1_file'].value = '';
            form.elements['evolutions_2_file'].value = '';
            toggleFormFields();
            document.getElementById('temp-url-container')?.remove();
            ['imageFile', 'evolutions_1_file', 'evolutions_2_file'].forEach(name => {
                const el = form.querySelector(`[name="${name}"]`);
                if(el) el.parentElement.style.display = 'block';
            });
        }
        
        function updateAuthUI(user) {
            const contentToLock = [dom.appContainer.querySelector('main'), dom.toggleFormBtn.closest('.flex.sm\\:flex-row'), dom.addEditFormContainer];
            if (user) {
                dom.authActionText.textContent = 'Çıkış Yap'; dom.authActionIcon.textContent = 'logout';
                dom.authActionBtn.onclick = () => { if (confirm('Çıkış yapmak istediğinizden emin misiniz?')) firebase.auth().signOut(); };
                closeLoginModal();
                fetchApiKeys().then(success => contentToLock.forEach(el => { if(el) { el.style.opacity = success ? '1' : '0.5'; el.style.pointerEvents = success ? 'auto' : 'none'; }}));
            } else {
                dom.authActionText.textContent = 'Giriş Yap'; dom.authActionIcon.textContent = 'login';
                dom.authActionBtn.onclick = openLoginModal;
                apiKeys = { imgbb_main_key: null, imgbb_easteregg_key: null };
                contentToLock.forEach(el => { if(el) { el.style.opacity = '0.5'; el.style.pointerEvents = 'none'; }});
                dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt'; dom.toggleFormIcon.textContent = 'add';
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            fetchItems();
            dom.loginSubmitBtn.addEventListener('click', async () => {
                const email = dom.adminEmailInput.value; const password = dom.adminPasswordInput.value;
                dom.loginStatus.textContent = '';
                try {
                    dom.loginSubmitBtn.disabled = true; dom.loginSubmitBtn.textContent = 'Giriş yapılıyor...';
                    await firebase.auth().signInWithEmailAndPassword(email, password);
                } catch (error) { dom.loginStatus.textContent = `Hata: ${error.code}`;
                } finally { dom.loginSubmitBtn.disabled = false; dom.loginSubmitBtn.textContent = 'Giriş Yap'; }
            });
            firebase.auth().onAuthStateChanged(updateAuthUI);
            dom.itemTypeSelect.addEventListener('change', toggleFormFields);
            dom.addEditForm.addEventListener('submit', handleFormSubmit);
            dom.cancelButton.addEventListener('click', () => {
                resetForm(); dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt'; dom.toggleFormIcon.textContent = 'add';
            });
            dom.searchInput.addEventListener('input', renderAdminPanel);
            dom.toggleFormBtn.addEventListener('click', () => {
                const isHidden = dom.addEditFormContainer.classList.toggle('hidden');
                dom.toggleFormText.textContent = isHidden ? 'Yeni Kayıt' : 'Formu Kapat';
                dom.toggleFormIcon.textContent = isHidden ? 'add' : 'close';
                if(isHidden) resetForm();
            });
            dom.addEditFormContainer.classList.add('hidden');
        });

        toggleFormFields = function() {
            const selectedType = dom.itemTypeSelect.value;
            dom.addEditForm.querySelector('#character-fields').classList.toggle('hidden', selectedType !== 'character');
            dom.addEditForm.querySelector('#fusion-fields').classList.toggle('hidden', selectedType !== 'fusion');
            dom.addEditForm.querySelector('#easter-egg-fields').classList.toggle('hidden', selectedType !== 'easterEgg');
            dom.addEditForm.querySelector('[name="imageFile"]').parentElement.querySelector('label').textContent = selectedType === 'easterEgg' ? 'Easter Egg Resim' : 'Ana Resim';
        };

        // YENİ: Fonksiyon adı ve içeriği tüm butonları (edit, delete, retire) kapsayacak şekilde güncellendi
        setupActionListeners = function() {
            dom.adminGrid.querySelectorAll('.edit-button, .delete-button, .retire-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { id, type, action } = e.currentTarget.dataset;
                    if (button.classList.contains('edit-button')) {
                        loadItemForEdit(id, type);
                    } else if (button.classList.contains('delete-button')) {
                        deleteItem(id, type);
                    } else if (button.classList.contains('retire-button')) {
                        // YENİ: Emekliye ayırma veya geri alma işlemi
                        if (action === 'retire') {
                            retireItem(id, type);
                        } else if (action === 'unretire') {
                            unretireItem(id, type);
                        }
                    }
                });
            });
        };

        loadItemForEdit = function(itemId, itemType) {
            resetForm();
            // YENİ: Emekli karakterler düzenlenemez
            const itemData = (itemType === 'easterEgg' ? easterEggs : characters).find(i => i.id === itemId);
            if (!itemData) return alert("Aktif kayıt bulunamadı veya bu kayıt düzenlenemez.");
            
            editingItemId = itemId; editingItemType = itemType;
            dom.formTitle.textContent = "Kaydı Düzenle";
            dom.itemTypeSelect.value = itemType; dom.itemTypeSelect.disabled = true;
            const form = dom.addEditForm;
            form.elements['id'].value = itemId; form.elements['id'].readOnly = true; 
            form.elements['name'].value = itemData.name || '';
            ['imageFile', 'evolutions_1_file', 'evolutions_2_file'].forEach(name => {
                if(form.querySelector(`[name="${name}"]`)) form.querySelector(`[name="${name}"]`).parentElement.style.display = 'none';
            });
            const urlContainer = document.createElement('div');
            urlContainer.id = 'temp-url-container'; urlContainer.className = 'flex flex-col gap-3';
            const createUrlInput = (name, placeholder, value) => `<input type="text" name="${name}" placeholder="${placeholder}" class="form-input" value="${value}">`;
            let inputsHtml = createUrlInput('imageUrl', 'Ana Resim URL', itemData.imageUrl || '');
            if (itemType === 'character') {
                inputsHtml += createUrlInput('evolutions_1', '2★ Resim URL', itemData.evolutions?.find(e=>e.star===2)?.imageUrl || '');
                inputsHtml += createUrlInput('evolutions_2', '3★ Resim URL', itemData.evolutions?.find(e=>e.star===3)?.imageUrl || '');
            }
            urlContainer.innerHTML = inputsHtml;
            form.insertBefore(urlContainer, form.querySelector('#character-fields'));
            if (itemType === 'fusion') {
                form.elements['fusionPartners_0'].value = itemData.fusionPartners?.[0] || '';
                form.elements['fusionPartners_1'].value = itemData.fusionPartners?.[1] || '';
            } else if (itemType === 'easterEgg') {
                form.elements['originalCharacterId'].value = itemData.originalCharacterId || '';
            }
            dom.saveButton.textContent = "Güncelle";
            dom.cancelButton.classList.remove('hidden');
            toggleFormFields();
            dom.addEditFormContainer.classList.remove('hidden');
            dom.toggleFormText.textContent = 'Formu Kapat'; dom.toggleFormIcon.textContent = 'close';
        };
        uploadImageToImgBB = async function(file, apiKey) {
            if (!file) return null; if (!apiKey) { alert("API anahtarı eksik."); throw new Error("API anahtarı eksik."); }
            const formData = new FormData(); formData.append('image', file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, { method: 'POST', body: formData });
                if (!res.ok) throw new Error(`Yükleme hatası: ${res.statusText}`);
                const result = await res.json();
                if (result.success) return result.data.url; else throw new Error(result.error.message);
            } catch (error) { alert(`Resim yüklenemedi: ${error.message}`); return null; }
        };
        handleFormSubmit = async function(event) {
            event.preventDefault();
            const form = dom.addEditForm; const id = form.elements['id'].value.trim();
            if (!id || !firebase.auth().currentUser) return alert(!id ? "ID boş olamaz." : "Giriş yapmalısınız.");
            dom.saveButton.textContent = 'Yükleniyor...'; dom.saveButton.disabled = true;
            try {
                const type = dom.itemTypeSelect.value, isEditing = !!editingItemId;
                let data = { name: form.elements['name'].value.trim() };
                let collectionName = type === 'easterEgg' ? 'easterEggs' : 'characters';
                if (isEditing) {
                    data.imageUrl = form.elements['imageUrl']?.value.trim() || '';
                } else {
                    const mainFile = form.elements['imageFile']?.files[0];
                    if (!mainFile) throw new Error("Ana resim seçmek zorunludur.");
                    data.imageUrl = await uploadImageToImgBB(mainFile, type === 'easterEgg' ? apiKeys.imgbb_easteregg_key : apiKeys.imgbb_main_key);
                    if(!data.imageUrl) throw new Error("Ana resim yüklenemedi.");
                }
                if (type === 'character') {
                    data.star = 1; data.isFusion = false; data.evolutions = [];
                    if (isEditing) {
                        const evo1Url = form.elements['evolutions_1']?.value.trim();
                        const evo2Url = form.elements['evolutions_2']?.value.trim();
                        if (evo1Url) data.evolutions.push({ star: 2, imageUrl: evo1Url });
                        if (evo2Url) data.evolutions.push({ star: 3, imageUrl: evo2Url });
                    } else {
                        const [evo1File, evo2File] = [form.elements['evolutions_1_file']?.files[0], form.elements['evolutions_2_file']?.files[0]];
                        const [evo1Url, evo2Url] = await Promise.all([ uploadImageToImgBB(evo1File, apiKeys.imgbb_main_key), uploadImageToImgBB(evo2File, apiKeys.imgbb_main_key) ]);
                        if (evo1Url) data.evolutions.push({ star: 2, imageUrl: evo1Url });
                        if (evo2Url) data.evolutions.push({ star: 3, imageUrl: evo2Url });
                    }
                } else if (type === 'fusion') {
                    data.star = 4; data.isFusion = true;
                    data.fusionPartners = [form.elements['fusionPartners_0'].value.trim(), form.elements['fusionPartners_1'].value.trim()].filter(Boolean);
                } else if (type === 'easterEgg') {
                    data.originalCharacterId = form.elements['originalCharacterId'].value.trim();
                }
                await db.collection(collectionName).doc(id).set(data, { merge: true });
                alert(`Kayıt başarıyla ${isEditing ? 'güncellendi' : 'kaydedildi'}!`);
                await fetchItems();
                dom.addEditFormContainer.classList.add('hidden');
                dom.toggleFormText.textContent = 'Yeni Kayıt'; dom.toggleFormIcon.textContent = 'add';
                resetForm();
            } catch (error) { alert(`Hata: ${error.message}`); } finally { dom.saveButton.textContent = isEditing ? 'Güncelle' : 'Kaydet'; dom.saveButton.disabled = false; }
        };
        deleteItem = async function(itemId, itemType) {
            // YENİ: Silme işlemi emekli ve aktif karakterler için ayrı koleksiyonlardan yapılıyor
            const isRetired = dismissed.some(i => i.id === itemId);
            const collectionName = isRetired ? 'dismissed' : (itemType === 'easterEgg' ? 'easterEggs' : 'characters');
            const item = [...characters, ...easterEggs, ...dismissed].find(i => i.id === itemId);

            if (!item || !confirm(`'${item.name}' adlı kaydı ${isRetired ? 'KALICI OLARAK' : ''} silmek istediğinizden emin misiniz?`)) return;
            try {
                if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");
                await db.collection(collectionName).doc(itemId).delete();
                alert("Kayıt silindi.");
                await fetchItems();
            } catch (error) { alert(`Silme hatası: ${error.message}`); }
        };

        // YENİ: Karakteri emekliye ayırma fonksiyonu
        retireItem = async function(itemId, itemType) {
            if (!confirm("Bu kaydı emekliye ayırmak istediğinizden emin misiniz? Liste görünümünde kalacak ama düzenlenemeyecektir.")) return;
            if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");

            const sourceCollection = itemType === 'easterEgg' ? 'easterEggs' : 'characters';
            const itemRef = db.collection(sourceCollection).doc(itemId);
            
            try {
                const doc = await itemRef.get();
                if (!doc.exists) throw new Error("Taşınacak kayıt bulunamadı.");
                
                const itemData = doc.data();
                // Veriyi 'dismissed' koleksiyonuna yazarken hangi tür olduğunu da ekliyoruz
                await db.collection('dismissed').doc(itemId).set({ ...itemData, type: itemType });
                // Eski koleksiyondan siliyoruz
                await itemRef.delete();

                alert("Kayıt başarıyla emekliye ayrıldı.");
                await fetchItems(); // Listeyi yenile
            } catch (error) {
                alert(`Emekliye ayırma hatası: ${error.message}`);
            }
        };

        // YENİ: Karakteri emeklilikten geri alma fonksiyonu
        unretireItem = async function(itemId, itemType) {
            if (!confirm("Bu kaydı tekrar aktif hale getirmek istediğinizden emin misiniz?")) return;
            if(!firebase.auth().currentUser) return alert("Giriş yapmalısınız.");
            
            const dismissedRef = db.collection('dismissed').doc(itemId);

            try {
                const doc = await dismissedRef.get();
                if (!doc.exists) throw new Error("Geri alınacak kayıt bulunamadı.");

                let itemData = doc.data();
                const originalType = itemData.type || 'character'; // Eğer tip belirtilmemişse varsayılan olarak character
                const destinationCollection = originalType === 'easterEgg' ? 'easterEggs' : 'characters';
                
                delete itemData.type; // 'type' alanını geri taşırken silebiliriz.

                // Veriyi orijinal koleksiyonuna geri yaz
                await db.collection(destinationCollection).doc(itemId).set(itemData);
                // 'dismissed' koleksiyonundan sil
                await dismissedRef.delete();

                alert("Kayıt tekrar aktifleştirildi.");
                await fetchItems(); // Listeyi yenile
            } catch (error) {
                alert(`Geri alma hatası: ${error.message}`);
            }
        };

        // YENİ: fetchItems fonksiyonu 'dismissed' koleksiyonunu da çekecek şekilde güncellendi
        fetchItems = async function() {
            try {
                const [charsSnap, eeSnap, dismissedSnap] = await Promise.all([
                    db.collection('characters').get(), 
                    db.collection('easterEggs').get(),
                    db.collection('dismissed').get() // Emekli olanları da çek
                ]);
                characters = charsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                easterEggs = eeSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Emekli olanları ayrı bir dizide tut ve onlara bir işaret ekle
                dismissed = dismissedSnap.docs.map(doc => ({ id: doc.id, ...doc.data(), isRetired: true }));
                renderAdminPanel();
            } catch (error) { 
                console.error("Veri çekme hatası:", error);
                dom.adminGrid.innerHTML = `<p class="col-span-full text-center text-lg text-red-500">Veriler çekilemedi. Lütfen konsolu kontrol edin.</p>`; 
            }
        };
        enlargeImage = function(event, src) { if(event) event.stopPropagation(); if(src) {dom.enlargedImage.src = src; dom.enlargedImageOverlay.classList.remove('hidden');} };
        closeEnlargedImage = function(event) { if (event) event.stopPropagation(); dom.enlargedImageOverlay.classList.add('hidden'); };
        fetchApiKeys = async function() {
            try {
                const apiKeysDoc = await db.collection('settings').doc('apiKeys').get();
                if (apiKeysDoc.exists) { apiKeys = apiKeysDoc.data(); return true; }
                else { alert("Yönetici API anahtarları bulunamadı."); return false; }
            } catch (error) { alert("API anahtarları çekilemedi."); return false; }
        };
    </script>
</body>
</html>
